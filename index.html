<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Vehicle Clearance - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark-theme-bg { background-color: #0f172a; color: #e2e8f0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }

        #settings-panel { transition: transform 0.3s ease-in-out; }
        #settings-backdrop { transition: background-color 0.3s ease-in-out; }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .mobile-safe-container, .mobile-modal-content {
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }
        .mobile-button { min-height: 44px; }
        .mobile-input { font-size: 16px; }

        .mobile-modal {
            position: fixed; inset: 0;
            padding: 1rem; max-height: 100vh;
            overflow-y: auto; display: flex;
            align-items: flex-start; justify-content: center;
            padding-top: 2rem;
        }
    </style>
</head>
<body class="dark-theme-bg">
    <div id="app-root"><div class="min-h-screen flex items-center justify-center"><div class="spinner h-16 w-16 border-4 border-slate-700 border-t-blue-500 rounded-full"></div></div></div>

<script type="module">
	import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, Timestamp, getDoc, where, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuration ---
    const ADMIN_INVITE_CODE = "ADMIN2025";
    const firebaseConfig = {
        apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
        authDomain: "vehicle-clearance.firebaseapp.com",
        projectId: "vehicle-clearance",
        storageBucket: "vehicle-clearance.appspot.com",
        messagingSenderId: "187403368572",
        appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
    };

    // --- App Initialization ---
    const appRoot = document.getElementById("app-root");
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (err) {
        appRoot.innerHTML = `<div class="p-4 text-center text-red-500 bg-red-100 rounded-lg"><b>Error:</b> Firebase initialization failed.</div>`;
    }

    // --- State ---
    let clearances = [], clearanceRequests = [], vvips = [], currentAdminProfile = null;
    let unsubClearances, unsubRequests, unsubVVIPs;
    let authMode = "login";

    // --- Notifications & Utilities ---
    const showNotification = (message, type = "success") => { /* ... */ };
    const formatDate = (d) => d ? new Date(d.toDate ? d.toDate() : d).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'2-digit'}) : "N/A";
    const toISODate = d => d ? new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split("T")[0] : "";
    const getFormObj = form => Object.fromEntries(new FormData(form).entries());
    const parseLocalDate = (str) => str ? new Date(str + 'T00:00:00') : null;

    // — Icon Library —
    const icons = {
        logout: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
        plus: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
        shield: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
        x: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
        settings: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33-1.82V15a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
    };

    // — Render Functions —
    const renderAdminLogin = () => {
        document.body.className = 'dark-theme-bg';
        const isSignup = authMode === "signup";
        appRoot.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-slate-800/80 backdrop-blur-sm border border-blue-500/20 rounded-2xl shadow-2xl p-8 space-y-6 animate-fade-in">
                <div class="text-center"><div class="w-12 h-12 mx-auto text-blue-400">${icons.shield}</div><h1 class="text-3xl font-bold text-white mt-4">Admin Panel</h1><p class="text-slate-400">${isSignup ? "Create a new admin account" : "Sign in to manage"}</p></div>
                <form id="auth-form" class="space-y-4">
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Invite Code</label><input type="password" name="inviteCode" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" /></div>
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Email</label><input type="email" name="email" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" ${isSignup ? 'required' : ''} /></div>
                    <div><label class="text-sm text-slate-300">Username</label><input type="text" name="username" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required /></div>
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Designation</label><input type="text" name="designation" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" ${isSignup ? 'required' : ''} /></div>
                    <div><label class="text-sm text-slate-300">Password</label><input type="password" name="password" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required /></div>
                    <button type="submit" class="w-full py-3 rounded-lg text-white bg-blue-600 hover:bg-blue-700 mobile-button">${isSignup ? "Sign Up" : "Login"}</button>
                </form>
                <p class="text-center text-sm text-slate-400"><span>${isSignup ? "Have an account?" : "Need an account?"}</span><button id="auth-toggle-button" class="font-medium text-blue-400 hover:text-blue-300 ml-1">${isSignup ? "Login" : "Sign Up"}</button></p>
            </div>
        </div>`;
    };
    function renderAdminDashboard(adminUser) {
        document.body.className = 'dark-theme-bg';
        appRoot.innerHTML = `
            <header class="bg-slate-800 shadow-md sticky top-0 z-30">
                <nav class="w-full max-w-7xl mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3"><span class="text-blue-500 w-8 h-8">${icons.shield}</span><span class="text-xl font-bold">Admin Dashboard</span></div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-slate-400 hidden sm:block">${adminUser.username}</span>
                        <button id="settings-btn" title="Settings" class="p-2 text-slate-300 hover:bg-slate-700 rounded-full">${icons.settings}</button>
                        <button id="logout-button" title="Logout" class="p-2 rounded-full text-white bg-red-500 hover:bg-red-600">${icons.logout}</button>
                    </div>
                </nav>
            </header>
            <main class="w-full max-w-7xl mx-auto p-4 md:p-8 mobile-safe-container">
                <div class="space-y-10">
                    <section>
                        <div class="flex items-center gap-4 mb-4"><h2 class="text-2xl font-semibold">Pending Requests</h2><span id="requests-count-badge" class="flex items-center justify-center min-w-[24px] h-6 px-2 text-xs font-bold text-white bg-red-500 rounded-full">0</span></div>
                        <div id="requests-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                    </section>
                    <section>
                        <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Manage Clearances</h2>
                            <div class="flex gap-2">
                                <button id="add-clearance-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mobile-button"><span class="w-5 h-5">${icons.plus}</span><span class="hidden sm:inline">Fast Track</span></button>
                            </div>
                        </div>
                        <div id="clearance-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    </section>
                </div>
            </main>
            <div id="modal-container"></div>
            <div id="settings-panel-container"></div>`;
    }
    const renderRequestsList = () => { /* ... */ };
    const renderClearancesList = () => { /* ... */ };
    const renderVVIPListForSettings = () => { /* ... */ };
    const renderReviewModal = (data) => { /* ... */ };
    const handleEscortCheckboxChange = (checkbox, textareaId) => { /* ... */ };
    const renderConfirmationModal = (title, message, onConfirm) => { /* ... */ };
    const renderRejectionModal = (requestId) => { /* ... */ };
    const renderWhatsAppModal = (request) => { /* ... */ };
    const toggleSettingsPanel = (show) => { /* ... */ };

    // --- Data Fetching & State Update ---
    async function initializeAdminData() {
        try {
            const clearancesSnap = await getDocs(collection(db, "vehicleClearances"));
            clearances = clearancesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            clearances.sort((a, b) => (b.entryDate?.toMillis() || 0) - (a.entryDate?.toMillis() || 0));
            
            const requestsQuery = query(collection(db, "clearanceRequests"), where("status", "==", "pending"));
            const requestsSnap = await getDocs(requestsQuery);
            clearanceRequests = requestsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            clearanceRequests.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            const vvipsSnap = await getDocs(collection(db, "vvips"));
            vvips = vvipsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            vvips.sort((a, b) => a.vehicleNumber.localeCompare(b.vehicleNumber));

            renderAdminDashboard(currentAdminProfile);
            renderClearancesList();
            renderRequestsList();
            
            // Now, attach real-time listeners
            attachRealtimeListeners();

        } catch (error) {
            console.error("Failed to fetch initial admin data:", error);
            showNotification("Could not load initial data. Please refresh.", "error");
            // Render a minimal dashboard to allow logout
            renderAdminDashboard(currentAdminProfile);
        }
    }

    function attachRealtimeListeners() {
        unsubClearances = onSnapshot(collection(db, "vehicleClearances"), snap => {
            clearances = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            clearances.sort((a, b) => (b.entryDate?.toMillis() || 0) - (a.entryDate?.toMillis() || 0));
            renderClearancesList();
        });

        unsubRequests = onSnapshot(query(collection(db, "clearanceRequests"), where("status", "==", "pending")), snap => {
            clearanceRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            clearanceRequests.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            renderRequestsList();
            const badge = document.getElementById('requests-count-badge');
            if(badge) {
                badge.textContent = clearanceRequests.length;
                badge.classList.toggle('hidden', clearanceRequests.length === 0);
            }
        });

        unsubVVIPs = onSnapshot(collection(db, "vvips"), snap => {
            vvips = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            vvips.sort((a, b) => a.vehicleNumber.localeCompare(b.vehicleNumber));
            if (document.getElementById('vvip-list-container-settings')) renderVVIPListForSettings();
        });
    }
    
    // — Auth Listener —
    onAuthStateChanged(auth, async (user) => {
        unsubClearances?.(); unsubRequests?.(); unsubVVIPs?.();
        currentAdminProfile = null;
        if (user && !user.isAnonymous) {
            try {
                const adminDoc = await getDoc(doc(db, "admins", user.uid));
                if (adminDoc.exists()) {
                    currentAdminProfile = { uid: user.uid, ...adminDoc.data() };
                    await initializeAdminData();
                } else { await signOut(auth); }
            } catch (error) {
                console.error("Auth state change error:", error);
                await signOut(auth);
            }
        } else {
            renderAdminLogin();
        }
    });

    const saveClearanceData = async (form, editingId = null) => { /* ... */ };
    
    // --- Event Listeners ---
    document.body.addEventListener("click", async (e) => {
        const button = e.target.closest('button');
        if (!button || button.type === 'submit') return;

        e.preventDefault();
        const closeModal = () => { if (document.getElementById('modal-container')) document.getElementById('modal-container').innerHTML = ''; };

        try {
            if (button.id === 'logout-button') { await signOut(auth); }
            else if (button.id === 'settings-btn') { toggleSettingsPanel(true); }
            else if (button.id === 'close-settings-panel-btn' || e.target.id === 'settings-backdrop') { toggleSettingsPanel(false); }
            else if (button.id === 'add-clearance-btn') { renderReviewModal({}); }
            else if (button.classList.contains('edit-btn')) { const c = clearances.find(x => x.id === button.dataset.id); if (c) renderReviewModal(c); }
            else if (button.classList.contains('review-btn')) { const r = clearanceRequests.find(x => x.id === button.dataset.id); if (r) renderReviewModal(r); }
            else if (button.id === "auth-toggle-button") { authMode = authMode === "login" ? "signup" : "login"; renderAdminLogin(); }
            else if (button.id === 'close-modal-btn' || button.id === 'close-modal-btn-cancel' || (e.target.id === 'review-modal-backdrop' && e.target.id === e.currentTarget.id)) { closeModal(); }
        } catch (error) { console.error("Click Error:", error); showNotification(error.message, "error"); }
    });

    document.body.addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        if (button) button.disabled = true;
        try {
            if (form.id === "auth-form") {
                const { email, password, username } = getFormObj(form);
                const q = query(collection(db, "admins"), where("username", "==", username.trim()));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { throw new Error("Invalid username or password."); }
                const adminData = querySnapshot.docs[0].data();
                if (!adminData.email) { throw new Error("Login error: Account is missing an email."); }
                await signInWithEmailAndPassword(auth, adminData.email, password);
            }
        } catch (error) {
            showNotification(error.message, "error");
        } finally { if (button) button.disabled = false; }
    });
</script>
</body>
</html>


