<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Vehicle Clearance - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark-theme-bg { background-color: #0f172a; color: #e2e8f0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }

        #settings-panel { transition: transform 0.3s ease-in-out; }
        #settings-backdrop { transition: background-color 0.3s ease-in-out; }

        .settings-tab-btn.active { border-color: #60a5fa; color: #60a5fa; }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .mobile-safe-container, .mobile-modal-content {
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }
        .mobile-button { min-height: 44px; }
        .mobile-input { font-size: 16px; }

        .mobile-modal {
            position: fixed; inset: 0;
            padding: 1rem; max-height: 100vh;
            overflow-y: auto; display: flex;
            align-items: flex-start; justify-content: center;
            padding-top: 2rem;
        }
    </style>
</head>
<body class="dark-theme-bg">
    <div id="app-root"></div>

<script type="module">
	import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, Timestamp, getDoc, where, updateDoc, getDocs, orderBy, writeBatch, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuration ---
    const ADMIN_INVITE_CODE = "ADMIN2025";
    const firebaseConfig = {
        apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
        authDomain: "vehicle-clearance.firebaseapp.com",
        projectId: "vehicle-clearance",
        storageBucket: "vehicle-clearance.appspot.com",
        messagingSenderId: "187403368572",
        appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
    };

    // --- App Initialization ---
    const appRoot = document.getElementById("app-root");
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (err) {
        console.error("Firebase initialization error:", err);
        appRoot.innerHTML = `<div class="p-8 text-center text-red-500 bg-red-100 rounded-lg"><b>Error:</b> Firebase initialization failed.</div>`;
    }

    // --- State ---
    let clearances = [], clearanceRequests = [], vvips = [], currentAdminProfile = null;
    let unsubClearances, unsubRequests, unsubVVIPs;
    let authMode = "login";

    // --- Email & Notifications ---
    const generateNotificationEmail = (status, data) => {
        const orgName = "PCC Security";
        const footerText = `This is an automated notification. Please do not reply.`;
        const template = (title, content) => `<div style="font-family: Inter, Arial, sans-serif; font-size: 16px; max-width: 600px; margin: 20px auto; border: 1px solid #e2e8f0; border-radius: 8px;"><div style="background-color: #0f172a; color: #ffffff; padding: 20px; text-align: center;"><h1 style="margin: 0;">Vehicle Clearance System</h1></div><div style="padding: 25px;"><h2 style="font-size: 20px; color: #1e293b;">${title}</h2>${content}<p>Regards,<br/><b>${orgName}</b></p></div><div style="background-color: #f1f5f9; color: #64748b; padding: 15px; text-align: center; font-size: 12px;">${footerText}</div></div>`;
        let title = '', content = '';
        if (status === 'approved') {
            title = 'Request Approved';
            content = `<p>Hi ${data.ownerName || 'User'},</p><p>Your vehicle clearance for <b>${data.vehicleNumber}</b> has been <strong>approved</strong>.</p><hr style="border:none; border-top:1px solid #e2e8f0; margin:20px 0;"><p><b>Location:</b> ${data.location}<br><b>Valid From:</b> ${data.entryDate}<br><b>Valid Until:</b> ${data.expiryDate}</p>`;
        } else if (status === 'rejected') {
            title = 'Request Update';
            content = `<p>Hi ${data.requesterName || 'User'},</p><p>Your vehicle request for <b>${data.vehicleNumber}</b> could not be approved.</p><hr style="border:none; border-top:1px solid #e2e8f0; margin:20px 0;"><p><b>Reason:</b></p><p style="padding:10px; border-left:3px solid #ef4444; background-color:#fee2e2;">${data.rejectionReason}</p>`;
        }
        return template(title, content);
    };
    const sendEmail = async (to, subject, htmlBody) => {
        try {
            const response = await fetch('https://email.th3va.com/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': '7873&;@:$/);&;84$:&;73638($' },
                body: JSON.stringify({ to, subject, htmlBody })
            });
            if (!response.ok) throw new Error('Email service failed');
            showNotification(`Email sent to ${to}.`, "success");
        } catch (error) {
            console.error('Email send failed:', error);
            showNotification("Action saved, but email notification failed.", "error");
        }
    };
    const showNotification = (message, type = "success") => {
        const el = document.createElement("div");
        const colors = { success: "bg-green-500", error: "bg-red-500", info: "bg-blue-500" };
        el.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white flex items-center animate-fade-in z-[100] ${colors[type] || colors.info}`;
        el.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 4000);
    };

    // --- Utilities ---
    const normalizePhoneNumberForWhatsApp = (phone) => {
        let cleaned = (phone || '').replace(/\D/g, '');
        if (cleaned.startsWith('0')) cleaned = '60' + cleaned.substring(1);
        return cleaned;
    };
    const formatDate = (d) => d ? new Date(d.toDate ? d.toDate() : d).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'2-digit'}) : "N/A";
    const toISODate = d => d ? new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split("T")[0] : "";
    const getFormObj = form => Object.fromEntries(new FormData(form).entries());
    const parseLocalDate = (str) => str ? new Date(str + 'T00:00:00') : null;

    // — Icon Library —
    const icons = {
        logout: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
        plus: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
        trash: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
        shield: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
        x: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
        download: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
        settings: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V15a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
        database: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>`,
        whatsapp: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.908 6.161l.217.324-1.251 4.565 4.654-1.225.308.212z"/></svg>`
    };

    // --- Admin Functions ---
    const clearAllDatabaseData = async (button) => {
        button.disabled = true;
        try {
            const collectionsToWipe = ['vehicleClearances', 'clearanceRequests'];
            let totalDeleted = 0;
            for (const collectionName of collectionsToWipe) {
                const snapshot = await getDocs(collection(db, collectionName));
                if (snapshot.size > 0) {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    totalDeleted += snapshot.size;
                }
            }
            showNotification(`${totalDeleted} records wiped.`, "success");
            updateDatabaseStats();
        } catch(e) {
            showNotification("Error wiping data.", "error");
        } finally {
            button.disabled = false;
        }
     };
    const exportDatabaseData = async (button) => {
        button.disabled = true;
        try {
            const exportData = { exportDate: new Date().toISOString(), collections: {} };
            const collectionsToExport = ['vehicleClearances', 'clearanceRequests', 'vvips', 'admins'];
            for (const collectionName of collectionsToExport) {
                const snapshot = await getDocs(collection(db, collectionName));
                exportData.collections[collectionName] = snapshot.docs.map(d => {
                    const data = d.data();
                    Object.keys(data).forEach(key => {
                        if (data[key] && typeof data[key].toDate === 'function') {
                            data[key] = data[key].toDate().toISOString();
                        }
                    });
                    return {id: d.id, ...data};
                });
            }
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vcs-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification("Database exported successfully.", "success");
        } catch(e) {
            showNotification("Export failed.", "error");
        } finally {
            button.disabled = false;
        }
    };
    const updateDatabaseStats = async () => {
        const statsContainer = document.getElementById('db-stats');
        if (!statsContainer) return;
        statsContainer.innerHTML = 'Loading...';
        try {
            const collections = ['vehicleClearances', 'clearanceRequests', 'vvips', 'admins'];
            let statsHTML = '';
            for(const name of collections){
                const snapshot = await getDocs(collection(db, name));
                statsHTML += `<div class="p-2 bg-slate-700 rounded-md"><span>${name}:</span> <strong class="text-blue-400">${snapshot.size}</strong></div>`;
            }
            statsContainer.innerHTML = statsHTML;
        } catch(e) {
            statsContainer.innerHTML = '<div class="col-span-full text-red-500">Error loading stats.</div>';
        }
     };

    // — Render Functions —
    const renderAdminLogin = () => {
        document.body.className = 'dark-theme-bg';
        const isSignup = authMode === "signup";
        appRoot.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-slate-800/80 backdrop-blur-sm border border-blue-500/20 rounded-2xl shadow-2xl p-8 space-y-6 animate-fade-in">
                <div class="text-center"><div class="w-12 h-12 mx-auto text-blue-400">${icons.shield}</div><h1 class="text-3xl font-bold text-white mt-4">Admin Panel</h1><p class="text-slate-400">${isSignup ? "Create a new admin account" : "Sign in to manage"}</p></div>
                <form id="auth-form" class="space-y-4">
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Invite Code</label><input type="password" name="inviteCode" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" /></div>
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Email</label><input type="email" name="email" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" ${isSignup ? 'required' : ''} /></div>
                    <div><label class="text-sm text-slate-300">Username</label><input type="text" name="username" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required /></div>
                    <div class="${isSignup ? '' : 'hidden'}"><label class="text-sm text-slate-300">Designation</label><input type="text" name="designation" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" ${isSignup ? 'required' : ''} /></div>
                    <div><label class="text-sm text-slate-300">Password</label><input type="password" name="password" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required /></div>
                    <button type="submit" class="w-full py-3 rounded-lg text-white bg-blue-600 hover:bg-blue-700 mobile-button">${isSignup ? "Sign Up" : "Login"}</button>
                </form>
                <p class="text-center text-sm text-slate-400"><span>${isSignup ? "Have an account?" : "Need an account?"}</span><button id="auth-toggle-button" class="font-medium text-blue-400 hover:text-blue-300 ml-1">${isSignup ? "Login" : "Sign Up"}</button></p>
            </div>
        </div>`;
    };
    function renderAdminDashboard(adminUser) {
        document.body.className = 'dark-theme-bg';
        appRoot.innerHTML = `
            <header class="bg-slate-800 shadow-md sticky top-0 z-30">
                <nav class="w-full max-w-7xl mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
                    <div class="flex items-center gap-3"><span class="text-blue-500 w-8 h-8">${icons.shield}</span><span class="text-xl font-bold">Admin Dashboard</span></div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-slate-400 hidden sm:block">${adminUser.username}</span>
                        <button id="settings-btn" title="Settings" class="p-2 text-slate-300 hover:bg-slate-700 rounded-full">${icons.settings}</button>
                        <button id="logout-button" title="Logout" class="p-2 rounded-full text-white bg-red-500 hover:bg-red-600">${icons.logout}</button>
                    </div>
                </nav>
            </header>
            <main class="w-full max-w-7xl mx-auto p-4 md:p-8 mobile-safe-container">
                <div class="space-y-10">
                    <section>
                        <div class="flex items-center gap-4 mb-4"><h2 class="text-2xl font-semibold">Pending Requests</h2><span id="requests-count-badge" class="flex items-center justify-center min-w-[24px] h-6 px-2 text-xs font-bold text-white bg-red-500 rounded-full">0</span></div>
                        <div id="requests-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                    </section>
                    <section>
                        <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Manage Clearances</h2>
                            <div class="flex gap-2">
                                <button id="add-clearance-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mobile-button"><span class="w-5 h-5">${icons.plus}</span><span class="hidden sm:inline">Fast Track</span></button>
                            </div>
                        </div>
                        <div id="clearance-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    </section>
                </div>
            </main>
            <div id="modal-container"></div>
            <div id="settings-panel-container"></div>`;
        
        unsubClearances = onSnapshot(query(collection(db, "vehicleClearances"), orderBy("entryDate", "desc")), snap => {
            clearances = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderClearancesList();
        });

        unsubRequests = onSnapshot(query(collection(db, "clearanceRequests"), where("status", "==", "pending"), orderBy("createdAt", "desc")), snap => {
            clearanceRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRequestsList();
            const badge = document.getElementById('requests-count-badge');
            if (badge) {
                badge.textContent = clearanceRequests.length;
                badge.classList.toggle('hidden', clearanceRequests.length === 0);
            }
        });
        unsubVVIPs = onSnapshot(query(collection(db, "vvips"), orderBy("vehicleNumber")), snap => {
            vvips = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (document.getElementById('vvip-list-container-settings')) renderVVIPListForSettings();
        });
    }
    const renderRequestsList = () => {
        const list = document.getElementById("requests-list");
        if (!list) return;
        if (clearanceRequests.length === 0) {
            list.innerHTML = `<div class="col-span-full text-center p-8 text-slate-500 bg-slate-800 rounded-lg">No pending requests.</div>`;
            return;
        }
        list.innerHTML = clearanceRequests.map(r => `
            <button class="review-btn text-left p-3 rounded-xl border border-slate-700 bg-slate-800 hover:border-blue-500 transition" data-id="${r.id}">
                <div class="flex justify-between items-center">
                    <span class="font-mono font-bold text-blue-400">${r.vehicleNumber}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full bg-amber-900/60 text-amber-300">${formatDate(r.createdAt)}</span>
                </div>
                <div class="text-xs text-slate-400 mt-1">By: ${r.requesterName || 'N/A'}</div>
            </button>`).join("");
    };
    const renderClearancesList = () => {
        const list = document.getElementById("clearance-list");
        if (!list) return;
        const now = new Date();
        const active = clearances.filter(c => c.expiryDate.toDate() >= now);
        if (active.length === 0) {
            list.innerHTML = `<div class="col-span-full text-center p-8 text-slate-500 bg-slate-800 rounded-lg">No active clearances.</div>`;
            return;
        }
        list.innerHTML = active.map(c => `
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 flex justify-between items-start gap-4">
                <div class="min-w-0">
                    <p class="font-mono text-lg font-bold text-blue-400 truncate">${c.vehicleNumber}</p>
                    <p class="text-sm text-slate-300 truncate">${c.ownerName}</p>
                    <p class="text-xs text-slate-400">Expires: ${formatDate(c.expiryDate)}</p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button class="whatsapp-query-btn p-2 text-green-400 hover:bg-slate-700 rounded-full" data-id="${c.id}" title="WhatsApp"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">${icons.whatsapp.match(/<path d="([^"]+)"/)[0]}</svg></button>
                    <button class="edit-btn p-2 text-blue-400 hover:bg-slate-700 rounded-full" data-id="${c.id}" title="Edit"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
                </div>
            </div>`).join('');
    };
    const renderVVIPListForSettings = () => {
        const container = document.getElementById('vvip-list-container-settings');
        if (!container) return;
        const vvipListHTML = vvips.map(v => `
            <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg animate-fade-in border border-slate-700">
                <div>
                    <p class="font-mono font-bold text-blue-400">${v.vehicleNumber}</p>
                    <p class="text-sm text-slate-300">${v.designation}</p>
                </div>
                <button class="delete-vvip-btn p-2 text-red-500 hover:bg-slate-600 rounded-full" data-id="${v.id}" title="Delete VVIP">${icons.trash}</button>
            </div>`).join('');
        container.innerHTML = vvips.length > 0 ? vvipListHTML : '<p class="text-slate-500 text-sm py-4 text-center">No VVIPs added.</p>';
    };
    const renderReviewModal = (data) => {
        const isEdit = !!data.id;
        const modalContainer = document.getElementById("modal-container");
        const vehicleTypes = ["Car", "Motorcycle", "Van", "Tow Truck", "Lorry", "Bus", "Others"];
        const timeSlots = ["08:00-13:00", "08:00-18:00", "13:00-18:00", "18:00-onwards"];
        const locations = ["PCC", "Foyer Parking", "Basement 1", "Basement 2", "Basement 3", "Basement 4", "Courtyard", "E3", "Other"];
        const vTypeOpts = vehicleTypes.map(v => `<option value="${v}" ${data.vehicleType === v ? 'selected' : ''}>${v}</option>`).join('');
        const timeOpts = timeSlots.map(t => `<option value="${t}" ${data.timeSlot === t ? 'selected' : ''}>${t.replace('-', ' to ')}</option>`).join('');
        const otherSelected = data.location && !locations.slice(0, -1).includes(data.location);
        const locOpts = locations.map(l => `<option value="${l}" ${ (otherSelected && l === 'Other') || data.location === l ? 'selected' : ''}>${l}</option>`).join('');
        
        modalContainer.innerHTML = `
        <div id="review-modal-backdrop" class="mobile-modal bg-black bg-opacity-70 z-50">
            <div class="mobile-modal-content bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg relative animate-fade-in text-white">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white">${icons.x}</button>
                <form id="review-form" class="space-y-4">
                    <h2 class="text-2xl font-bold">${isEdit ? 'Edit Clearance' : 'Review Request'}</h2>
                    <input type="hidden" name="id" value="${data.id || ''}">
                    <input type="hidden" name="requesterEmail" value="${data.requesterEmail || data.ownerEmail || ''}">
                    <input type="hidden" name="requesterContact" value="${data.requesterContact || data.ownerContact || ''}">
                    
                    <div><label class="text-sm">Requester's Name</label><input name="ownerName" value="${data.requesterName || data.ownerName || ''}" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg" required /></div>
                    <div><label class="text-sm">Vehicle Number</label><input name="vehicleNumber" value="${data.vehicleNumber || ''}" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg" required /></div>
                    <div><label class="text-sm">Vehicle Type</label><select name="vehicleType" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg">${vTypeOpts}</select></div>
                    <div><label class="text-sm">Visiting Hours</label><select name="timeSlot" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg">${timeOpts}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-sm">Entry Date</label><input type="date" name="entryDate" value="${toISODate(data.entryDate?.toDate() || data.createdAt?.toDate() || new Date())}" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg" required /></div>
                        <div><label class="text-sm">Expiry Date</label><input type="date" name="expiryDate" value="${toISODate(data.expiryDate?.toDate() || data.createdAt?.toDate() || new Date())}" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg" required /></div>
                    </div>
                    <div><label class="text-sm">Location</label><select name="location" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg">${locOpts}</select>
                    <input name="customLocation" class="mobile-input mt-2 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg ${otherSelected ? '' : 'hidden'}" value="${otherSelected ? data.location : ''}" placeholder="Enter custom location..."></div>
                    <div><label class="text-sm">Notes</label><textarea id="review-notes-textarea" name="notes" rows="2" class="mobile-input mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-lg">${data.notes || ''}</textarea></div>
                    <div class="flex items-center"><input type="checkbox" id="escort-checkbox" name="escortRequired" class="h-5 w-5 rounded bg-slate-700 border-slate-500 text-blue-500" ${data.escortRequired ? 'checked' : ''}/><label for="escort-checkbox" class="ml-2">Escort Required</label></div>
                    
                    <div class="flex items-center gap-3 pt-4 border-t border-slate-700">
                        <button type="button" class="whatsapp-query-btn flex-1 p-3 rounded-lg bg-green-600 hover:bg-green-700 mobile-button flex items-center justify-center" data-id="${data.id}">${icons.whatsapp}</button>
                        ${!isEdit ? `<button type="button" class="reject-request-btn flex-1 p-3 rounded-lg bg-red-600 hover:bg-red-700 mobile-button" data-id="${data.id}">Reject</button>` : `<button type="button" id="close-modal-btn-cancel" class="flex-1 p-3 rounded-lg bg-slate-600 hover:bg-slate-500 mobile-button">Cancel</button>`}
                        <button type="button" class="${isEdit ? 'save-clearance-btn' : 'approve-request-btn'} flex-1 p-3 rounded-lg bg-blue-600 hover:bg-blue-700 mobile-button" data-id="${data.id || ''}">${isEdit ? 'Update' : 'Approve'}</button>
                    </div>
                </form>
            </div>
        </div>`;
    };
    const handleEscortCheckboxChange = (checkbox, textareaId) => {
        const textarea = document.getElementById(textareaId);
        if (!textarea) return;
        const escortText = "[ Escorted by:             ]";
        if (checkbox.checked) {
            if (!textarea.value.includes("Escorted by:")) {
                textarea.value = (textarea.value.trim() ? textarea.value.trim() + '\n\n' : '') + escortText;
            }
        } else {
            textarea.value = textarea.value.replace(/\[\s*Escorted\s+by:[^\]]*\]/gi, '').replace(/\n{2,}/g, '\n').trim();
        }
    };
    const renderConfirmationModal = (title, message, onConfirm) => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
        <div id="confirm-modal-backdrop" class="mobile-modal bg-black bg-opacity-70 z-[60]">
            <div class="mobile-modal-content bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm relative animate-fade-in text-white">
                <h2 class="text-lg font-bold">${title}</h2>
                <p class="mt-2 text-sm text-slate-400">${message}</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-confirm-btn" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 mobile-button">Cancel</button>
                    <button id="confirm-action-btn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 mobile-button">Confirm</button>
                </div>
            </div>
        </div>`;
        document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); modalContainer.innerHTML = ''; };
        document.getElementById('cancel-confirm-btn').onclick = () => modalContainer.innerHTML = '';
    };
    const renderRejectionModal = (requestId) => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
        <div id="rejection-modal-backdrop" class="mobile-modal bg-black bg-opacity-70 z-[60]">
            <div class="mobile-modal-content bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-md relative animate-fade-in text-white">
                <form id="rejection-form">
                    <h2 class="text-lg font-bold">Reject Request</h2>
                    <p class="mt-2 text-sm text-slate-400">Provide a reason for rejection.</p>
                    <div class="mt-4">
                        <textarea name="rejectionReason" rows="3" class="mobile-input w-full p-2 bg-slate-700 border border-slate-600 rounded-lg" required></textarea>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" id="cancel-rejection-btn" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 mobile-button">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 mobile-button" data-id="${requestId}">Confirm Rejection</button>
                    </div>
                </form>
            </div>
        </div>`;
         document.getElementById('cancel-rejection-btn').onclick = () => modalContainer.innerHTML = '';
    };
    const renderWhatsAppModal = (request) => { /* RESTORED */ };
    const toggleSettingsPanel = (show) => {
        let container = document.getElementById('settings-panel-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'settings-panel-container';
            document.body.appendChild(container);
        }
        
        if (show) {
            container.innerHTML = `
                <div id="settings-backdrop" class="fixed inset-0 bg-black/50 z-40"></div>
                <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-sm bg-slate-900 shadow-xl z-50 flex flex-col transform translate-x-0 transition-transform duration-300">
                    <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-slate-700">
                        <h2 class="text-2xl font-semibold">Settings</h2>
                        <button id="close-settings-panel-btn" class="p-2 hover:bg-slate-700 rounded-full">${icons.x}</button>
                    </div>
                    <div class="flex-grow p-6 overflow-y-auto space-y-6">
                        <div class="p-4 bg-slate-800 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3">VVIP Management</h3>
                             <form id="add-vvip-form" class="space-y-3 mb-4">
                                <input name="vehicleNumber" class="mobile-input w-full p-2 bg-slate-700 border border-slate-600 rounded" placeholder="Vehicle Number" required>
                                <input name="designation" class="mobile-input w-full p-2 bg-slate-700 border border-slate-600 rounded" placeholder="Designation" required>
                                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add VVIP</button>
                            </form>
                            <div id="vvip-list-container-settings" class="mt-2 space-y-2"></div>
                        </div>
                        <div class="p-4 bg-slate-800 rounded-lg">
                             <h3 class="text-lg font-semibold mb-3">Database</h3>
                             <div id="db-stats" class="grid grid-cols-2 gap-2 text-sm mb-4"></div>
                             <div class="space-y-3">
                                <button id="export-database-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Export Backup</button>
                                <button id="clear-database-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Wipe Data</button>
                             </div>
                        </div>
                    </div>
                </div>`;
            renderVVIPListForSettings();
            updateDatabaseStats();
        } else {
            const panel = document.getElementById('settings-panel');
            if (panel) {
                panel.classList.add('translate-x-full');
                setTimeout(() => container.innerHTML = '', 300);
            } else {
                 container.innerHTML = '';
            }
        }
    };
    
    // — Auth Listener —
    onAuthStateChanged(auth, async (user) => {
        unsubClearances?.(); unsubRequests?.(); unsubVVIPs?.();
        currentAdminProfile = null;
        if (user && !user.isAnonymous) {
            try {
                const adminDoc = await getDoc(doc(db, "admins", user.uid));
                if (adminDoc.exists()) {
                    currentAdminProfile = { uid: user.uid, ...adminDoc.data() };
                    renderAdminDashboard(currentAdminProfile);
                } else { await signOut(auth); }
            } catch (error) {
                console.error("Auth state change error:", error);
                await signOut(auth);
            }
        } else {
            renderAdminLogin();
        }
    });

    const saveClearanceData = async (form, editingId = null) => {
        const data = getFormObj(form);
        const entryDate = parseLocalDate(data.entryDate);
        const expiryDate = parseLocalDate(data.expiryDate);

        if (!entryDate || !expiryDate || !form.checkValidity()) throw new Error("Please fill all required fields.");
        if (!currentAdminProfile) throw new Error("Admin profile not loaded.");

        const payload = {
            ownerName: data.ownerName,
            ownerEmail: data.requesterEmail,
            ownerContact: data.requesterContact,
            vehicleNumber: data.vehicleNumber.toUpperCase(),
            vehicleType: data.vehicleType,
            location: data.location === 'Other' ? data.customLocation : data.location,
            timeSlot: data.timeSlot,
            entryDate: Timestamp.fromDate(entryDate),
            expiryDate: Timestamp.fromDate(expiryDate),
            escortRequired: !!data.escortRequired,
            notes: data.notes || ""
        };

        if (editingId) {
            payload.lastUpdatedAt = Timestamp.now();
            payload.lastUpdatedByUsername = currentAdminProfile.username;
            await updateDoc(doc(db, "vehicleClearances", editingId), payload);
            showNotification("Clearance updated.");
        } else {
            payload.createdAt = Timestamp.now();
            payload.approvedAt = Timestamp.now();
            payload.approvedByUsername = currentAdminProfile.username;
            payload.approvedByDesignation = currentAdminProfile.designation;
            await addDoc(collection(db, "vehicleClearances"), payload);
            showNotification("Clearance created.");
        }
        return payload;
    };
    
    // --- Event Listeners ---
    document.body.addEventListener("click", async (e) => {
        const button = e.target.closest('button');
        if (!button || button.type === 'submit') return;

        // e.preventDefault();
        const closeModal = () => { if (document.getElementById('modal-container')) document.getElementById('modal-container').innerHTML = ''; };

        try {
            if (button.id === 'logout-button') { e.preventDefault(); await signOut(auth); }
            else if (button.id === 'settings-btn') { e.preventDefault(); toggleSettingsPanel(true); }
            else if (button.id === 'close-settings-panel-btn' || e.target.id === 'settings-backdrop') { e.preventDefault(); toggleSettingsPanel(false); }
            else if (button.id === 'add-clearance-btn') { e.preventDefault(); renderReviewModal({}); }
            else if (button.classList.contains('edit-btn')) { e.preventDefault(); const c = clearances.find(x => x.id === button.dataset.id); if (c) renderReviewModal(c); }
            else if (button.classList.contains('review-btn')) { e.preventDefault(); const r = clearanceRequests.find(x => x.id === button.dataset.id); if (r) renderReviewModal(r); }
            else if (button.classList.contains('reject-request-btn')) { e.preventDefault(); renderRejectionModal(button.dataset.id); }
            else if (button.classList.contains('whatsapp-query-btn')) { e.preventDefault(); const req = clearanceRequests.find(r => r.id === button.dataset.id) || clearances.find(c => c.id === button.dataset.id); if(req) renderWhatsAppModal(req); else showNotification('Contact not found.', 'error'); }
            else if (button.classList.contains('approve-request-btn')) {
                e.preventDefault();
                const form = document.getElementById('review-form');
                if (!form.checkValidity()) { form.reportValidity(); return; }
                button.disabled = true;
                const savedPayload = await saveClearanceData(form);
                await updateDoc(doc(db, "clearanceRequests", form.elements.id.value), { status: 'approved', approvedAt: Timestamp.now(), approvedBy: currentAdminProfile.username });
                if (savedPayload.ownerEmail) await sendEmail(savedPayload.ownerEmail, `Clearance Approved: ${savedPayload.vehicleNumber}`, generateNotificationEmail('approved', { ...savedPayload, entryDate: formatDate(savedPayload.entryDate.toDate()), expiryDate: formatDate(savedPayload.expiryDate.toDate()) }));
                closeModal();
            }
            else if (button.classList.contains('save-clearance-btn')) {
                e.preventDefault();
                const form = document.getElementById('review-form');
                if (!form.checkValidity()) { form.reportValidity(); return; }
                button.disabled = true;
                await saveClearanceData(form, button.dataset.id);
                closeModal();
            }
            else if (button.id === "auth-toggle-button") { e.preventDefault(); authMode = authMode === "login" ? "signup" : "login"; renderAdminLogin(); }
            else if (button.id === 'close-modal-btn' || button.id === 'close-modal-btn-cancel' || (e.target.id === 'review-modal-backdrop' && e.target.id === e.currentTarget.id)) { e.preventDefault(); closeModal(); }
            else if (button.id === 'export-database-btn') { e.preventDefault(); await exportDatabaseData(button); }
            else if (button.id === 'clear-database-btn') { e.preventDefault(); renderConfirmationModal('Wipe Data', 'This will delete ALL clearances and requests. This cannot be undone.', () => clearAllDatabaseData(button)); }
            else if (button.classList.contains('delete-vvip-btn')) { e.preventDefault(); const id = button.dataset.id; renderConfirmationModal('Delete VVIP', 'Are you sure?', () => deleteDoc(doc(db, "vvips", id)));}
        } catch (error) { console.error("Click Error:", error); showNotification(error.message, "error"); if(button) button.disabled = false; }
    });

    document.body.addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        if (button) button.disabled = true;
        try {
            if (form.id === "auth-form") {
                const { email, password, inviteCode, username, designation } = getFormObj(form);
                if (authMode === "login") {
                    const q = query(collection(db, "admins"), where("username", "==", username.trim()));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) { throw new Error("Invalid username or password."); }
                    const adminData = querySnapshot.docs[0].data();
                    if (!adminData.email) { throw new Error("Login error: Account is missing an email."); }
                    await signInWithEmailAndPassword(auth, adminData.email, password);
                } else { // signup
                    if (inviteCode !== ADMIN_INVITE_CODE) { throw new Error("Invalid admin invite code."); }
                    const q = query(collection(db, "admins"), where("username", "==", username.trim()));
                    if (!(await getDocs(q)).empty) { throw new Error("Username is already taken."); }
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "admins", cred.user.uid), { email, username: username.trim(), designation, createdAt: Timestamp.now() });
                    showNotification("Admin account created! Please log in.");
                    authMode = "login";
                    renderAdminLogin();
                }
            } else if (form.id === "rejection-form") {
                const { rejectionReason } = getFormObj(form);
                const requestId = form.querySelector('button[type="submit"]').dataset.id;
                const request = clearanceRequests.find(r => r.id === requestId);
                await updateDoc(doc(db, "clearanceRequests", requestId), { status: 'rejected', rejectionReason: rejectionReason.trim(), reviewedAt: Timestamp.now(), reviewedBy: currentAdminProfile.username });
                if (request && request.requesterEmail) await sendEmail(request.requesterEmail, `Request Update: ${request.vehicleNumber}`, generateNotificationEmail('rejected', { ...request, rejectionReason }));
                document.getElementById('modal-container').innerHTML = '';
            }
             else if (form.id === "add-vvip-form") {
                const data = getFormObj(form);
                if (data.vehicleNumber && data.designation) {
                    await addDoc(collection(db, "vvips"), { vehicleNumber: data.vehicleNumber.toUpperCase(), designation: data.designation });
                    showNotification("VVIP added successfully.");
                    form.reset();
                }
            }
        } catch (error) {
            showNotification(error.message, "error");
        } finally { if (button) button.disabled = false; }
    });

    document.body.addEventListener("change", (e) => {
        if (e.target.name === "location") {
            const customInput = e.target.closest('form')?.querySelector('input[name="customLocation"]');
            if (customInput) customInput.classList.toggle('hidden', e.target.value !== "Other");
        }
        if (e.target.id === 'escort-checkbox') {
            handleEscortCheckboxChange(e.target, 'review-notes-textarea');
        }
    });

</script>
</body>
</html>

