<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Vehicle Clearance Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0f172a; /* Darker slate background */
            color: #e2e8f0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Style for date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
        
        /* Custom modal styles */
        #modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        /* Scrollable Modal Body Fix */
        #modal-body {
            max-height: 65vh; /* Limit height to 65% of view height */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 4px; /* Avoid scrollbar overlap */
        }
        
        /* Mobile-friendly inputs */
        .mobile-input {
            width: 100%;
            max-width: 100%;
            font-size: 16px;
            padding: 0.75rem;
            box-sizing: border-box;
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.5rem;
            color: #f1f5f9; /* slate-100 */
        }
        .mobile-input:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
            box-shadow: 0 0 0 2px #1e293b, 0 0 0 4px #3b82f6;
        }
        /* Custom checkbox */
        .mobile-checkbox {
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #3b82f6;
            cursor: pointer;
        }
        .mobile-checkbox:focus {
             outline: none;
             box-shadow: 0 0 0 2px #1e293b, 0 0 0 4px #3b82f6;
        }
        
        /* Nav button styles */
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .nav-button[data-active="true"] {
            background-color: #3b82f6; /* blue-600 */
            color: #ffffff;
        }
        .nav-button[data-active="false"] {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
        }
        .nav-button[data-active="false"]:hover {
            background-color: #475569; /* slate-600 */
        }
        
        /* --- Keypad Styles --- */
        .keypad-btn {
            background: linear-gradient(145deg, #334155, #1e293b);
            border: 1px solid #475569;
            border-radius: 0.75rem; /* More rounded */
            font-size: 24px;
            font-weight: 600;
            color: #e2e8f0;
            padding: 1rem 0;
            cursor: pointer;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, background 0.1s ease-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .keypad-btn:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            transform: translateY(-1px);
        }
        .keypad-btn:active {
            transform: scale(0.97);
            background: #1e293b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5), inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .keypad-btn-icon svg {
            width: 28px;
            height: 28px;
        }
        
        /* --- Search Result Plate Styles --- */
        .car-plate-display {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column; /* Stack vertically */
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem; /* Increased padding */
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.1);
            gap: 1rem; /* Spacing between number and badge */
        }
        /* Status: CLEARED (Green) */
        .car-plate-display-cleared {
            background: linear-gradient(135deg, #166534 0%, #15803d 50%, #14532d 100%);
            border: 4px solid #4ade80;
        }
        /* Status: ESCORT (Orange/Amber) */
        .car-plate-display-escort {
            background: linear-gradient(135deg, #b45309 0%, #d97706 50%, #92400e 100%);
            border: 4px solid #fbbf24;
        }
        /* Status: EXPIRED / NOT FOUND (Red) */
        .car-plate-display-error {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 50%, #7f1d1d 100%);
            border: 4px solid #f87171;
        }

        .car-plate-text {
            font-family: 'Courier New', monospace;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
            color: white !important;
            font-size: 2.5rem; /* Slightly larger */
            flex-grow: 1;
            text-align: center;
            white-space: normal; /* Allow wrap if absolutely necessary */
            word-break: break-word;
            line-height: 1.1;
        }
        .plate-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 800;
            flex-shrink: 0;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .plate-status-badge.success { background-color: #16a34a; }
        .plate-status-badge.warning { background-color: #f59e0b; color: #000; }
        .plate-status-badge.error { background-color: #dc2626; }

        .search-highlight {
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #4ade80, 0 0 15px #4ade80; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #4ade80, 0 0 30px #4ade80; }
        }
        .glow-red {
            animation-name: glow-red;
        }
        @keyframes glow-red {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #f87171, 0 0 15px #f87171; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #f87171, 0 0 30px #f87171; }
        }
        .glow-amber {
            animation-name: glow-amber;
        }
        @keyframes glow-amber {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fbbf24, 0 0 15px #fbbf24; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #fbbf24, 0 0 30px #fbbf24; }
        }
        
        .exit-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid #475569;
            cursor: pointer;
            color: #cbd5e1;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .exit-btn:hover {
            background-color: #334155;
            color: #fff;
        }
        
        /* --- Search Result List Styles --- */
        .list-item {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .list-item-plate {
            font-family: monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: #e2e8f0;
            white-space: nowrap;
        }
        .list-item-location {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        .list-item-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .list-item-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }
        .badge-success { background: #052e16; color: #4ade80; border: 1px solid #14532d; }
        .badge-warning { background: #451a03; color: #fbbf24; border: 1px solid #78350f; }
        .badge-error   { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }

        /* Dropdown Styles */
        .dropdown-container {
            position: relative;
        }
        .more-btn {
            background: none;
            border: none;
            border-radius: 50%;
            padding: 6px;
            cursor: pointer;
            color: #94a3b8;
            transition: background-color 0.2s;
        }
        .more-btn:hover {
            background-color: #334155;
            color: #fff;
        }
        .more-btn svg { width: 20px; height: 20px; }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 8px;
            z-index: 10;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background-color: #475569;
        }
        .dropdown-item.danger { color: #f87171; }
        .dropdown-item.danger:hover {
            background-color: #991b1b;
            color: white;
        }
        
        /* Grid View Table Styles */
        .grid-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .grid-table th {
            text-align: left;
            padding: 0.75rem;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 1px solid #334155;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .grid-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #1e293b;
            color: #cbd5e1;
        }
        .grid-row:hover {
            background-color: #1e293b;
        }
        /* Left border status indicator */
        .status-border-success { border-left: 4px solid #16a34a; }
        .status-border-warning { border-left: 4px solid #f59e0b; }
        .status-border-error { border-left: 4px solid #dc2626; }

        /* PRINT STYLES - 24hr Log */
        @media print {
            body { background-color: white; color: black; }
            header, nav, #modal-backdrop, #print-btn-container { display: none !important; }
            #app-root { max-width: none; padding: 0; margin: 0; }
            
            /* Hide everything except the daily log container when printing */
            #view-content > div:not(#daily-log-container) { display: none; }
            #daily-log-container { display: block !important; background: white !important; border: none !important; box-shadow: none !important; padding: 0 !important; }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                font-family: 'Inter', sans-serif;
                font-size: 12px;
            }
            .print-table th {
                background-color: #f3f4f6;
                color: #111827;
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
                font-weight: bold;
                white-space: nowrap; /* Prevent header wrapping */
            }
            .print-table td {
                border: 1px solid #000;
                padding: 8px;
                color: #000;
                white-space: nowrap; /* Prevent cell wrapping */
            }
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid black;
                padding-bottom: 10px;
            }
            .print-header h1 { font-size: 24px; font-weight: bold; margin: 0; color: black; }
            .print-header p { margin: 5px 0 0; color: #333; }
        }
        
        /* Secondary Nav Dropdown */
        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 0.5rem;
            z-index: 50;
            min-width: 160px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .nav-dropdown.show { display: block; }
        
    </style>
</head>
<body>
    <!-- Main Application Root -->
    <div id="app-root" class="max-w-4xl mx-auto p-4 sm:p-6"></div>

    <!-- Global Modal for Confirmations -->
    <div id="modal-backdrop" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
        <div id="modal-content" class="w-full max-w-md bg-slate-800 rounded-xl shadow-2xl p-6 border border-slate-700 flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
            </div>
            
            <div id="modal-body" class="text-slate-300 flex-grow overflow-y-auto pr-2 mb-4"></div>
            
            <div id="modal-actions" class="flex-shrink-0 flex justify-end gap-3 pt-2 border-t border-slate-700">
                <button id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-slate-600 text-slate-200 hover:bg-slate-500 font-medium">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 font-medium">Confirm</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, Timestamp, query, where, getDocs, 
            doc, deleteDoc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, setLogLevel,
            onSnapshot, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
            authDomain: "vehicle-clearance.firebaseapp.com",
            projectId: "vehicle-clearance",
            storageBucket: "vehicle-clearance.appspot.com",
            messagingSenderId: "187403368572",
            appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
        };
        
        // --- App State ---
        let app, auth, db, authUser;
        let currentView = 'add'; // 'add', 'search', 'settings', 'log'
        let isGridView = false; 
        let allRows = []; 
        let filtered = [];
        let confirmCallback = null;
        let settingsUnsubscribe = null;
        let vehiclesUnsubscribe = null;
        let keypadMode = 'numeric'; // 'numeric' or 'alpha'
        
        const DB_COLLECTION = "vehicleClearances"; 
        const SETTINGS_COLLECTION = "publicConfig";
        const SETTINGS_DOC_ID = "panelSettings"; 
        let settingsDocRef;
        let appSettings = {
            requesters: [],
            escortBy: [],
            vehicleTypes: [],
            locations: [],
            approvedBy: []
        };
        const defaultSettings = {
            requesters: ["A DIV", "CID", "CAD"],
            escortBy: ["SMM", "HTX", "Alpha"],
            vehicleTypes: ["Car", "Motorcycle"],
            locations: ["PCC"],
            approvedBy: ["User A", "User B"]
        };


        // --- DOM Elements ---
        const appRoot = document.getElementById("app-root");
        const modalBackdrop = document.getElementById("modal-backdrop");
        const modalContent = document.getElementById("modal-content"); // To inject custom content
        const modalTitle = document.getElementById("modal-title");
        const modalBody = document.getElementById("modal-body");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");
        const modalConfirmBtn = document.getElementById("modal-confirm-btn");

        // --- Icons ---
        const icons = {
            add: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
            car: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 16H9m10 0h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1m-4 0H4a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h1m0 0v1a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1M4 16v1a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1H4Zm0 0H3m16 0h1M5 11h14M5 8h14"/></svg>`,
            motorcycle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 16H3a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1h2m16 0h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2m-3-11 3 3m-3-3-3 3m-2 11h3l3-6-4-3-4 3 3 6Z"/><circle cx="6.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            signOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
            keypadBackspace: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM18 13H9.83l1.59 1.59L10 16l-4-4 4-4 1.41 1.41L9.83 11H18v2z"/></svg>`,
            list: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`,
            grid: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`,
            clipboard: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>`,
            print: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
            menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>`
        };

        // --- Firebase Initialization ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug'); 

            onAuthStateChanged(auth, async (user) => {
                if (settingsUnsubscribe) settingsUnsubscribe();
                if (vehiclesUnsubscribe) vehiclesUnsubscribe();
                
                if (user) {
                    console.log("User logged in:", user.uid);
                    const adminDocRef = doc(db, "admins", user.uid);
                    const adminDocSnap = await getDoc(adminDocRef);

                    if (adminDocSnap.exists()) {
                        console.log("Admin user confirmed:", user.uid);
                        authUser = user;
                        await loadSettingsAndVehicles(); 
                        renderApp();
                    } else {
                        console.warn("User is not an admin:", user.uid);
                        authUser = null;
                        renderLoginScreen("Error: You are not authorized to use this panel.");
                        await signOut(auth);
                    }
                } else {
                    console.log("No user logged in.");
                    authUser = null;
                    renderLoginScreen();
                }
            });

        } catch (err) {
            console.error("Firebase initialization error:", err);
            renderLoginScreen("Firebase initialization error. Please refresh.");
        }
        
        // --- Data Loading Function ---
        const loadSettingsAndVehicles = async () => {
            if (!authUser) return;
            
            // 1. Load Settings
            try {
                settingsDocRef = doc(db, SETTINGS_COLLECTION, SETTINGS_DOC_ID);
                settingsUnsubscribe = onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appSettings.requesters = data.requesters || [];
                        appSettings.escortBy = data.escortBy || [];
                        appSettings.vehicleTypes = data.vehicleTypes || [];
                        appSettings.locations = data.locations || [];
                        appSettings.approvedBy = data.approvedBy || [];
                        console.log("Settings updated:", appSettings);
                    } else {
                        console.log("No settings doc found. Creating with defaults.");
                        setDoc(settingsDocRef, defaultSettings);
                        appSettings = { ...defaultSettings };
                    }
                    if (currentView === 'add' || currentView === 'settings') {
                        renderViewContent();
                    }
                });
            } catch (error) {
                console.error("Error loading settings:", error);
                showNotification(`Error loading settings: ${error.message}`, "error");
            }
            
            // 2. Load All Vehicles
            try {
                const vehiclesQuery = query(collection(db, DB_COLLECTION), where("__name__", "!=", "_panelSettingsDoc_"));
                vehiclesUnsubscribe = onSnapshot(vehiclesQuery, (snapshot) => {
                    allRows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Vehicle cache updated: ${allRows.length} vehicles.`);
                    if (currentView === 'search') {
                        if (isGridView) {
                            renderGridView();
                        } else {
                            applyFilter();
                        }
                    } else if (currentView === 'log') {
                        renderDailyLogView();
                    }
                }, (error) => {
                    console.error("Error fetching all vehicles:", error);
                    showNotification(`Failed to load vehicles: ${error.message}`, "error");
                });
            } catch (error) {
                 console.error("Error attaching vehicle listener:", error);
                 showNotification(`Error: ${error.message}`, "error");
            }
        };
        
        // --- Helper Functions ---
        
        const showNotification = (message, type = "success") => {
            const existingNotif = document.getElementById("global-notification");
            if (existingNotif) existingNotif.remove();

            const notification = document.createElement("div");
            notification.id = "global-notification";
            const colors = {
                success: "bg-green-600 border-green-500",
                error: "bg-red-600 border-red-500",
                info: "bg-blue-600 border-blue-500"
            };
            const icon = type === "success" ? "✓" : type === "error" ? "✗" : "ℹ";
            
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white flex items-center animate-fade-in z-[100] ${colors[type]} border-l-4 max-w-sm`;
            notification.innerHTML = `<span class="mr-3 text-lg font-bold">${icon}</span><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        };

        const parseLocalDate = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null;
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset);
        };

        const formatDate = (date) => {
            if (!date) return "N/A";
            const d = date instanceof Date ? date : (date.toDate ? date.toDate() : new Date(date));
            // Return format YYYY-MM-DD for input fields
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };
        
        const formatDateDisplay = (date) => {
             if (!date) return "N/A";
            const d = date instanceof Date ? date : (date.toDate ? date.toDate() : new Date(date));
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
        }

        // --- Auto-Formatter for Vehicle Number ---
        const formatVehicleNumber = (val) => {
            if (!val) return '';
            
            // Remove existing spaces first to get clean string
            const clean = val.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // Pattern: Letters + Numbers + Letters (e.g., SBS 1234 J)
            // Group 1: Initial Letters (1-3)
            // Group 2: Numbers (1-4)
            // Group 3: Suffix Letter (1)
            
            // Attempt to match: (LETTERS)(NUMBERS)(LETTER)
            const match = clean.match(/^([A-Z]+)(\d+)([A-Z]?)$/);
            
            if (match) {
                return `${match[1]} ${match[2]} ${match[3]}`.trim();
            }
            
            // Fallback if incomplete (e.g. just letters or letters+numbers)
            // Try: Letters + Numbers
            const matchPartial = clean.match(/^([A-Z]+)(\d+)$/);
            if (matchPartial) {
                return `${matchPartial[1]} ${matchPartial[2]}`.trim();
            }
            
            return clean;
        };

        // *** Status Checker Function ***
        const getVehicleStatus = (vehicle) => {
            if (!vehicle.expiryDate) return 'error';
            
            const now = new Date();
            const expiry = vehicle.expiryDate.toDate();
            expiry.setHours(23, 59, 59, 999); 

            if (now > expiry) {
                return 'expired';
            }
            if (vehicle.escortRequired) {
                return 'escort';
            }
            return 'active';
        };

        const showModal = (title, body, onConfirm) => {
            modalTitle.textContent = title;
            // Reset body
            modalBody.innerHTML = ''; 
            if (typeof body === 'string') {
                modalBody.textContent = body;
            } else {
                modalBody.appendChild(body);
            }
            
            confirmCallback = onConfirm;
            modalBackdrop.classList.remove("hidden");
        };

        const hideModal = () => {
            modalBackdrop.classList.add("hidden");
            confirmCallback = null;
        };

        const sanitizeInput = (str) => {
            return str.trim().replace(/[\s\n\r\t]/g, ' '); 
        };
        
        // --- Render Functions ---

        const renderLoginScreen = (error = null) => {
            appRoot.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in">
                    <div class="w-full max-w-md bg-slate-800 rounded-2xl shadow-2xl p-8 space-y-6 border border-slate-700">
                        <h1 class="text-3xl font-bold text-white text-center">Admin Panel Login</h1>
                        
                        ${error ? `<div id="login-error" class="p-3 rounded-lg bg-red-800/50 border border-red-700 text-red-300 text-sm">${error}</div>` : ''}

                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="login-username" class="block text-sm font-medium text-slate-300 mb-1">Username</label>
                                <input type="text" id="login-username" name="username" class="mobile-input" required />
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-slate-300 mb-1">Password</label>
                                <input type="password" id="login-password" name="password" class="mobile-input" required />
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="login-button" class="w-full px-6 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-500 transition-all">
                                    Login
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            if (!authUser) return renderLoginScreen("An error occurred. Please log in again."); 
            
            appRoot.innerHTML = `
                <header class="mb-6 space-y-3">
                    <div class="flex justify-between items-center">
                        <h1 class="text-4xl font-bold text-white tracking-tight">Vehicle Clearance Panel</h1>
                        <button id="sign-out-btn" title="Sign Out" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-red-700 hover:text-white transition-colors">
                            <span class="w-5 h-5">${icons.signOut}</span>
                            <span class="hidden sm:block text-sm font-medium">Sign Out</span>
                        </button>
                    </div>
                    <p class="text-slate-400">Manage vehicle clearance database.</p>
                </header>
                
                <nav class="flex gap-2 mb-6 overflow-visible relative">
                    <div class="flex-1 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button id="nav-add" data-view="add" class="nav-button flex items-center gap-2 whitespace-nowrap" data-active="${currentView === 'add'}">
                            <span class="w-5 h-5">${icons.add}</span> Add Vehicle
                        </button>
                        <button id="nav-search" data-view="search" class="nav-button flex items-center gap-2 whitespace-nowrap" data-active="${currentView === 'search'}">
                            <span class="w-5 h-5">${icons.search}</span> Search & Manage
                        </button>
                        
                        <!-- HIDDEN BY DEFAULT: Log and Settings are moved to dropdown -->
                    </div>
                    
                    <!-- More Menu Button -->
                    <div class="relative">
                        <button id="nav-menu-btn" class="nav-button flex items-center justify-center w-10 h-10" data-active="false">
                            ${icons.menu}
                        </button>
                        
                        <!-- Dropdown Menu for Extra Tools -->
                        <div id="nav-dropdown-menu" class="nav-dropdown">
                            <button data-view="log" class="dropdown-item flex items-center gap-3 mb-1">
                                <span class="w-5 h-5 text-slate-400">${icons.clipboard}</span> Daily Log
                            </button>
                            <button data-view="settings" class="dropdown-item flex items-center gap-3">
                                <span class="w-5 h-5 text-slate-400">${icons.settings}</span> Settings
                            </button>
                        </div>
                    </div>
                </nav>

                <main id="view-content" class="animate-fade-in"></main>
            `;
            
            renderViewContent();
        };
        
        const renderViewContent = () => {
             const contentEl = document.getElementById("view-content");
            if (!contentEl) return;
            
            if (currentView === 'add') {
                renderAddVehicleForm();
            } else if (currentView === 'search') {
                // If we were in Grid View, stay there, else show search
                if (isGridView) {
                    renderGridView();
                } else {
                    renderSearchView();
                }
            } else if (currentView === 'log') {
                renderDailyLogView();
            } else if (currentView === 'settings') {
                renderSettingsView();
            }
        };

        // ... (Other render functions remain the same: Add, Keypad, Search) ...
        
        const renderAddVehicleForm = () => {
            const contentEl = document.getElementById("view-content");
            if (!contentEl) return;

            const createOptions = (arr) => {
                if (!arr) return ''; 
                return arr.sort().map(item => `<option value="${item}">${item}</option>`).join('');
            };

            contentEl.innerHTML = `
                <div class="bg-slate-800/80 backdrop-blur-sm border border-slate-700/50 rounded-2xl shadow-lg p-6 sm:p-8">
                    <h2 class="text-2xl font-semibold text-white mb-6">Add New Vehicle Reference</h2>
                    <form id="add-vehicle-form" class="space-y-5">
                        <!-- Requester (New Field) -->
                        <div>
                            <label for="requester" class="block text-sm font-medium text-slate-300 mb-1">Requester</label>
                            <select id="requester" name="requester" class="mobile-input" required>
                                <option value="">Select requester...</option>
                                ${createOptions(appSettings.requesters)}
                            </select>
                        </div>

                        <!-- Vehicle Number -->
                        <div>
                            <label for="vehicleNumber" class="block text-sm font-medium text-slate-300 mb-1">Vehicle Number (Required)</label>
                            <input type="text" id="vehicleNumber" name="vehicleNumber" 
                                   class="mobile-input uppercase tracking-wider font-mono" 
                                   placeholder="E.G. SGA 1234 X" required />
                        </div>
                        
                        <!-- Owner Name (Optional) -->
                        <div>
                            <label for="ownerName" class="block text-sm font-medium text-slate-300 mb-1">Driver/Owner Name (Optional)</label>
                            <input type="text" id="ownerName" name="ownerName" class="mobile-input" placeholder="e.g. John Doe" />
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <!-- Vehicle Type -->
                            <div>
                                <label for="vehicleType" class="block text-sm font-medium text-slate-300 mb-1">Vehicle Type</label>
                                <select id="vehicleType" name="vehicleType" class="mobile-input" required>
                                    <option value="">Select type...</option>
                                    ${createOptions(appSettings.vehicleTypes)}
                                </select>
                            </div>
                            <!-- Location -->
                            <div>
                                <label for="location" class="block text-sm font-medium text-slate-300 mb-1">Location</label>
                                <select id="location" name="location" class="mobile-input" required>
                                    <option value="">Select location...</option>
                                    ${createOptions(appSettings.locations)}
                                </select>
                            </div>
                        </div>

                        <!-- Visiting Hours -->
                        <div>
                            <label for="timeSlot" class="block text-sm font-medium text-slate-300 mb-1">Visiting Hours</label>
                            <select id="timeSlot" name="timeSlot" class="mobile-input" required>
                                <option value="">Select a time slot...</option>
                                <option value="08:00-13:00">08:00 to 13:00</option>
                                <option value="08:00-18:00">08:00 to 18:00</option>
                                <option value="13:00-18:00">13:00 to 18:00</option>
                                <option value="18:00-onwards">18:00 onwards</option>
                                <option value="24 Hours">24 Hours</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <!-- Entry Date -->
                            <div>
                                <label for="entryDate" class="block text-sm font-medium text-slate-300 mb-1">Entry Date</label>
                                <input type="date" id="entryDate" name="entryDate" class="mobile-input" required />
                            </div>
                            <!-- Expiry Date -->
                            <div>
                                <label for="expiryDate" class="block text-sm font-medium text-slate-300 mb-1">Expiry Date</label>
                                <input type="date" id="expiryDate" name="expiryDate" class="mobile-input" required />
                            </div>
                        </div>
                        
                        <!-- Notes (Optional) -->
                        <div>
                            <label for="notes" class="block text-sm font-medium text-slate-300 mb-1">Notes / Purpose (Optional)</label>
                            <textarea id="notes" name="notes" rows="3" class="mobile-input" placeholder="e.g. Visitor for meeting, Contractor works..."></textarea>
                        </div>
                        
                        <!-- Escort Required -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="escortRequired" name="escortRequired" class="mobile-checkbox"/>
                                <label for="escortRequired" class="text-sm font-medium text-slate-300 cursor-pointer">Escort Required</label>
                            </div>
                            
                            <div id="escort-details-container" class="hidden pl-8">
                                <label for="escortBy" class="block text-sm font-medium text-slate-400 mb-1">Escort By</label>
                                <select id="escortBy" name="escortBy" class="mobile-input">
                                    <option value="">Select escort team...</option>
                                    ${createOptions(appSettings.escortBy)}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Approved By -->
                        <div>
                            <label for="approvedBy" class="block text-sm font-medium text-slate-300 mb-1">Approved By</label>
                            <select id="approvedBy" name="approvedBy" class="mobile-input" required>
                                <option value="">Select approver...</option>
                                ${createOptions(appSettings.approvedBy)}
                            </select>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-4 text-right">
                            <button type="submit" class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-500 transition-all shadow-lg shadow-blue-600/20">
                                Add Vehicle to Database
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Attach formatter to input
            setTimeout(() => {
                const vInput = document.getElementById('vehicleNumber');
                if (vInput) {
                    vInput.addEventListener('input', (e) => {
                        e.target.value = formatVehicleNumber(e.target.value);
                    });
                }
            }, 0);
        };
        
        const renderKeypad = () => {
            const keypadContainer = document.getElementById("keypad-container");
            if (!keypadContainer) return;
            
            let keypadHTML = '';
            if (keypadMode === 'numeric') {
                keypadHTML = `
                    <div id="keypad-numeric" class="grid grid-cols-3 gap-1.5" style="user-select: none;">
                        <button class="keypad-btn">1</button>
                        <button class="keypad-btn">2</button>
                        <button class="keypad-btn">3</button>
                        <button class="keypad-btn">4</button>
                        <button class="keypad-btn">5</button>
                        <button class="keypad-btn">6</button>
                        <button class="keypad-btn">7</button>
                        <button class="keypad-btn">8</button>
                        <button class="keypad-btn">9</button>
                        <button class="keypad-btn" id="keypad-toggle-alpha" style="font-size: 20px;">ABC</button>
                        <button class="keypad-btn">0</button>
                        <button class="keypad-btn keypad-btn-icon" data-action="backspace">${icons.keypadBackspace}</button>
                    </div>`;
            } else { // 'alpha'
                keypadHTML = `
                    <div id="keypad-alpha" class="space-y-1.5" style="user-select: none;">
                        <div class="flex gap-1.5 justify-center">
                            ${'QWERTYUIOP'.split('').map(k => `<button class="keypad-btn flex-1" style="padding: 0.75rem 0.25rem; font-size: 18px;">${k}</button>`).join('')}
                        </div>
                        <div class="flex gap-1.5 justify-center" style="padding: 0 0.5rem;">
                            ${'ASDFGHJKL'.split('').map(k => `<button class="keypad-btn flex-1" style="padding: 0.75rem 0.25rem; font-size: 18px;">${k}</button>`).join('')}
                        </div>
                        <div class="flex gap-1.5 justify-center">
                            <button class="keypad-btn" id="keypad-toggle-numeric" style="padding: 0.75rem 0.5rem; font-size: 18px; flex-grow: 1.5;">123</button>
                            ${'ZXCVBNM'.split('').map(k => `<button class="keypad-btn flex-1" style="padding: 0.75rem 0.25rem; font-size: 18px;">${k}</button>`).join('')}
                            <button class="keypad-btn keypad-btn-icon" data-action="backspace" style="padding: 0.75rem 0.5rem; flex-grow: 1.5;">${icons.keypadBackspace}</button>
                        </div>
                    </div>`;
            }
            keypadContainer.innerHTML = keypadHTML;
        };

        const renderSearchView = () => {
            const contentEl = document.getElementById("view-content");
            if (!contentEl) return;
            
            applyFilter(); // Start by filtering
            
            contentEl.innerHTML = `
                <div class="bg-slate-800/80 backdrop-blur-sm border border-slate-700/50 rounded-2xl shadow-lg p-6 sm:p-8">
                    <!-- Search Display -->
                    <input id="searchBox" placeholder="Start typing on keypad..." 
                           class="mobile-input text-center text-2xl font-mono tracking-widest mb-4 h-auto py-4 uppercase" 
                           inputmode="none" readonly>
                    
                    <!-- Keypad Container -->
                    <div id="keypad-container">
                        <!-- Keypad will be rendered by renderKeypad() -->
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="flex gap-3 mt-3">
                        <button id="clear-search-btn" class="flex-1 py-3 rounded-lg bg-slate-600 text-slate-200 hover:bg-slate-500 font-medium">Clear Search</button>
                        <button id="show-all-btn" class="flex-none px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-medium flex items-center justify-center">
                            <span class="mr-2">Show All</span> ${icons.grid}
                        </button>
                    </div>
                </div>
                
                <!-- Search Results Area -->
                <div id="search-results-container" class="mt-6">
                    <p id="search-message" class="text-center text-slate-400 py-4"></p>
                    <div id="search-results" class="space-y-4"></div>
                </div>
            `;
            
            renderKeypad(); 
            
            const searchBox = document.getElementById("searchBox");
            if (searchBox) {
                 const currentVal = filtered.length > 0 && filtered.length < allRows.length ? 
                                   formatVehicleNumber(filtered[0].vehicleNumber.substring(0, searchBox.value.replace(/\s/g, '').length)) :
                                   searchBox.value;
                searchBox.value = currentVal;
            }
            render();
        };

        const renderGridView = () => {
            const contentEl = document.getElementById("view-content");
            if (!contentEl) return;

            const expiredCount = allRows.filter(v => getVehicleStatus(v) === 'expired').length;

            contentEl.innerHTML = `
                <div class="bg-slate-800/80 backdrop-blur-sm border border-slate-700/50 rounded-2xl shadow-lg overflow-hidden">
                    <!-- Grid Header / Toolbar -->
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            ${icons.list} All Vehicles (${allRows.length})
                        </h2>
                        <div class="flex gap-2">
                            ${expiredCount > 0 ? `
                            <button id="batch-delete-expired-btn" class="px-3 py-1.5 text-sm rounded-lg bg-red-900/50 text-red-200 border border-red-800 hover:bg-red-900 hover:text-white transition-colors">
                                Delete Expired (${expiredCount})
                            </button>` : ''}
                            <button id="back-to-search-btn" class="px-3 py-1.5 text-sm rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition-colors">
                                Back to Search
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scrollable Grid Area -->
                    <div class="overflow-x-auto max-h-[65vh]">
                        <table class="grid-table w-full text-left">
                            <thead class="bg-slate-900/80 sticky top-0 z-10">
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Location</th>
                                    <th class="hidden sm:table-cell">Type</th>
                                    <th>Expiry</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                ${allRows.length === 0 ? `<tr><td colspan="6" class="text-center py-8 text-slate-500">No records found.</td></tr>` : 
                                  allRows.map(v => {
                                    const status = getVehicleStatus(v);
                                    let statusColorClass = 'status-border-success'; 
                                    let statusText = '<span class="text-green-400">Active</span>';
                                    
                                    if (status === 'expired') {
                                        statusColorClass = 'status-border-error';
                                        statusText = '<span class="text-red-400 font-bold">Expired</span>';
                                    } else if (status === 'escort') {
                                        statusColorClass = 'status-border-warning';
                                        statusText = '<span class="text-amber-400 font-bold">Escort</span>';
                                    }

                                    return `
                                    <tr class="grid-row ${statusColorClass}">
                                        <td class="font-mono font-bold text-white">${formatVehicleNumber(v.vehicleNumber)}</td>
                                        <td>${v.location}</td>
                                        <td class="hidden sm:table-cell text-slate-400">${v.vehicleType}</td>
                                        <td class="text-slate-400 whitespace-nowrap">${formatDateDisplay(v.expiryDate)}</td>
                                        <td>${statusText}</td>
                                        <td>
                                            <div class="dropdown-container relative inline-block text-left">
                                                <button class="more-btn" data-doc-id="${v.id}" title="More options">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                                                </button>
                                                <div class="dropdown-menu" id="dropdown-${v.id}">
                                                    <button class="dropdown-item" data-action="edit" data-id="${v.id}">Edit</button>
                                                    <button class="dropdown-item danger" data-action="delete" data-id="${v.id}" data-vehicle-number="${v.vehicleNumber}">Delete</button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        // *** NEW: Daily Log View Renderer ***
        const renderDailyLogView = () => {
            const contentEl = document.getElementById("view-content");
            if (!contentEl) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Filter vehicles that are valid for TODAY
            let todaysVehicles = allRows.filter(v => {
                if (!v.entryDate || !v.expiryDate) return false;
                const entry = v.entryDate.toDate();
                const expiry = v.expiryDate.toDate();
                expiry.setHours(23,59,59,999); // Include the full expiry day
                
                // Check if today falls within the valid range
                return entry <= tomorrow && expiry >= today;
            });

            // Sort: FOYER first, then Vehicle Number
            todaysVehicles.sort((a, b) => {
                const locA = (a.location || '').toUpperCase();
                const locB = (b.location || '').toUpperCase();
                const isFoyerA = locA.includes('FOYER');
                const isFoyerB = locB.includes('FOYER');

                if (isFoyerA && !isFoyerB) return -1;
                if (!isFoyerA && isFoyerB) return 1;
                return a.vehicleNumber.localeCompare(b.vehicleNumber);
            });

            const todayString = today.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            // Filename format: Vehicle_Clearance_YYYY-MM-DD.pdf (implied)
            const fileNameDate = today.toISOString().split('T')[0];
            const fileName = `Vehicle_Clearance_${fileNameDate}`;

            contentEl.innerHTML = `
                <div id="daily-log-container" class="bg-white text-black rounded-2xl shadow-lg overflow-hidden sm:p-8 p-4">
                    <!-- Web View Header -->
                    <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Daily Vehicle Log</h2>
                            <p class="text-gray-600">${todayString}</p>
                        </div>
                        <button onclick="document.title='${fileName}'; window.print(); setTimeout(() => { document.title = 'Vehicle Clearance Panel'; }, 500);" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors print:hidden">
                            ${icons.print} Print Log
                        </button>
                    </div>

                    <!-- Print Header (Hidden in Web, Visible in Print) -->
                    <div class="print-header hidden">
                        <h1>DAILY VEHICLE CLEARANCE LOG</h1>
                        <p>Date: ${todayString} | Shift: 24 Hours</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="print-table w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100 border-b-2 border-gray-300">
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Vehicle No</th>
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Type</th>
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Location</th>
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Approved By</th>
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Hours</th>
                                    <th class="p-3 border border-gray-300 font-bold whitespace-nowrap">Remarks / Escort</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${todaysVehicles.length === 0 ? 
                                    `<tr><td colspan="6" class="p-8 text-center text-gray-500 border border-gray-300">No vehicles scheduled for today.</td></tr>` : 
                                    todaysVehicles.map(v => `
                                    <tr class="border-b border-gray-200">
                                        <td class="p-3 border border-gray-300 font-mono font-bold text-lg whitespace-nowrap">${formatVehicleNumber(v.vehicleNumber)}</td>
                                        <td class="p-3 border border-gray-300 whitespace-nowrap">${v.vehicleType}</td>
                                        <td class="p-3 border border-gray-300 font-bold whitespace-nowrap">${v.location}</td>
                                        <td class="p-3 border border-gray-300 font-bold whitespace-nowrap">${v.approvedBy || ''}</td>
                                        <td class="p-3 border border-gray-300 font-bold whitespace-nowrap">${v.timeSlot || ''}</td>
                                        <td class="p-3 border border-gray-300 text-sm whitespace-nowrap">
                                            ${v.escortRequired ? `<strong>⚠️ Escort: ${v.escortBy}</strong> ` : ''}
                                            ${v.notes ? `<span class="italic">${v.notes}</span>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                                <!-- Extra blank rows for manual entries -->
                                ${Array(5).fill(0).map(() => `
                                    <tr class="border-b border-gray-200">
                                        <td class="p-3 border border-gray-300 h-12"></td>
                                        <td class="p-3 border border-gray-300"></td>
                                        <td class="p-3 border border-gray-300"></td>
                                        <td class="p-3 border border-gray-300"></td>
                                        <td class="p-3 border border-gray-300"></td>
                                        <td class="p-3 border border-gray-300"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-4 text-center print:block hidden">Generated on ${new Date().toLocaleString()}</p>
                </div>
            `;
        };

        const render = () => {
            const resultsEl = document.getElementById("search-results");
            const messageEl = document.getElementById("search-message");
            if (!resultsEl || !messageEl) return;

            const searchBox = document.getElementById("searchBox");
            const searchTerm = searchBox ? searchBox.value.trim().toUpperCase() : '';

            if (allRows.length === 0) {
                messageEl.textContent = 'No vehicles in database. Add one to get started.';
                messageEl.classList.remove('hidden');
                resultsEl.innerHTML = '';
                return;
            }
            
            const isSingleResultView = searchTerm.length >= 3 && (filtered.length === 1 || filtered.length === 0);

            if (isSingleResultView) {
                messageEl.classList.add('hidden');
                
                if (filtered.length === 0) {
                    resultsEl.innerHTML = `
                        <div class="animate-fade-in" style="width: 100%;">
                            <div class="car-plate-display car-plate-display-not-found" style="margin-bottom: 16px;">
                                <div class="car-plate-text">
                                    <span class="search-highlight glow-red">${formatVehicleNumber(searchTerm.replace(/\s/g, ''))}</span>
                                </div>
                                <div class="plate-status-badge error">
                                    NOT FOUND
                                </div>
                            </div>
                            <div class="bg-slate-800 rounded-2xl p-6 text-center">
                                <h3 class="text-xl font-semibold text-white">Access Denied</h3>
                                <p class="text-slate-400 mt-2">Vehicle <strong>${formatVehicleNumber(searchTerm.replace(/\s/g, ''))}</strong> is not on the list.</p>
                            </div>
                        </div>`;
                } 
                else {
                    const v = filtered[0];
                    const status = getVehicleStatus(v);
                    
                    let plateClass, textClass, statusText, badgeClass, statusBody;
                    
                    if (status === 'expired') {
                        plateClass = 'car-plate-display-error';
                        textClass = 'glow-red';
                        statusText = 'EXPIRED';
                        badgeClass = 'error';
                        statusBody = `
                            <div class="bg-red-900/20 border border-red-900/50 rounded-xl p-4 mb-4">
                                <p class="text-red-400 font-bold text-lg">⛔ CLEARANCE EXPIRED</p>
                                <p class="text-red-300/80 text-sm mt-1">Expired on: ${formatDateDisplay(v.expiryDate)}</p>
                            </div>`;
                    } else if (status === 'escort') {
                        plateClass = 'car-plate-display-escort';
                        textClass = 'glow-amber';
                        statusText = 'ESCORT REQUIRED';
                        badgeClass = 'warning';
                        statusBody = `
                            <div class="bg-amber-900/20 border border-amber-900/50 rounded-xl p-4 mb-4 animate-pulse">
                                <p class="text-amber-400 font-bold text-lg">⚠️ ESCORT REQUIRED</p>
                                <p class="text-amber-300/80 text-sm mt-1">Escort By: <span class="font-bold text-white">${v.escortBy}</span></p>
                            </div>`;
                    } else {
                        plateClass = 'car-plate-display-cleared';
                        textClass = 'search-highlight';
                        statusText = '✓ CLEARED';
                        badgeClass = 'success';
                        statusBody = ''; // Normal active state
                    }

                    resultsEl.innerHTML = `
                        <div class="animate-fade-in" style="width: 100%;">
                            <div class="car-plate-display ${plateClass} animate-fade-in" style="margin-bottom: 16px;">
                                <div class="car-plate-text">
                                    <span class="${textClass}">${formatVehicleNumber(v.vehicleNumber)}</span>
                                </div>
                                <div class="plate-status-badge ${badgeClass}">
                                    ${statusText}
                                </div>
                            </div>
                            
                            <div class="bg-slate-800 rounded-2xl p-6 text-center border border-slate-700">
                                ${statusBody}
                                
                                <div class="grid grid-cols-2 gap-4 text-left mb-6">
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Location</p>
                                        <p class="text-lg font-bold text-white">${v.location || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Type</p>
                                        <p class="text-lg font-medium text-slate-300">${v.vehicleType || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Valid From</p>
                                        <p class="text-sm text-slate-300">${formatDateDisplay(v.entryDate)}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Valid Until</p>
                                        <p class="text-sm text-slate-300">${formatDateDisplay(v.expiryDate)}</p>
                                    </div>
                                     ${v.ownerName ? `
                                    <div class="col-span-2 pt-2 border-t border-slate-700">
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Driver / Owner</p>
                                        <p class="text-sm text-slate-300">${v.ownerName}</p>
                                    </div>` : ''}
                                     ${v.notes ? `
                                    <div class="col-span-2 pt-2 border-t border-slate-700">
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Notes</p>
                                        <p class="text-sm text-slate-300 italic">"${v.notes}"</p>
                                    </div>` : ''}
                                     ${v.requester ? `
                                    <div class="col-span-2 pt-2 border-t border-slate-700">
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Requester</p>
                                        <p class="text-sm text-slate-300">${v.requester}</p>
                                    </div>` : ''}
                                </div>

                                <button id="exit-single-view-btn" class="exit-btn w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-semibold transition-all">Back to Full List</button>
                            </div>
                        </div>`;
                }
                return;
            }

            messageEl.classList.add('hidden');
            if (filtered.length === 0 && !searchTerm) {
                 messageEl.textContent = 'Showing all vehicles. Use keypad to search.';
                 messageEl.classList.remove('hidden');
            } else if (filtered.length > 0 && searchTerm) {
                 messageEl.textContent = `Showing ${filtered.length} matching vehicles.`;
                 messageEl.classList.remove('hidden');
            } else if (filtered.length === allRows.length && searchTerm === '') {
                 messageEl.textContent = `Showing all ${allRows.length} vehicles.`;
                 messageEl.classList.remove('hidden');
            }
            
            resultsEl.innerHTML = filtered.map(v => {
                const status = getVehicleStatus(v);
                let badgeHTML = '';
                
                if (status === 'expired') {
                    badgeHTML = `<span class="list-item-badge badge-error">Expired</span>`;
                } else if (status === 'escort') {
                    badgeHTML = `<span class="list-item-badge badge-warning">Escort</span>`;
                } else {
                    badgeHTML = `<span class="list-item-badge badge-success">Cleared</span>`;
                }

                return `
                <div class="list-item animate-fade-in">
                    <div class="list-item-content">
                        <div class="list-item-plate">${formatVehicleNumber(v.vehicleNumber)}</div>
                        <div class="list-item-location">${v.location || 'N/A'}</div>
                    </div>
                    <div class="list-item-right">
                        ${badgeHTML}
                        <div class="dropdown-container">
                            <button class="more-btn" data-doc-id="${v.id}" title="More options">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </button>
                            <div class="dropdown-menu" id="dropdown-${v.id}">
                                <button class="dropdown-item" data-action="edit" data-id="${v.id}">Edit</button>
                                <button class="dropdown-item danger" data-action="delete" data-id="${v.id}" data-vehicle-number="${v.vehicleNumber}">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        };
        
        const renderSettingsView = () => {
            const contentEl = document.getElementById("view-content");
            if (!contentEl) return;
            
            const renderCategory = (key, title, placeholder) => {
                const items = appSettings[key] || [];
                return `
                <section class="p-4 bg-slate-900/50 rounded-lg border border-slate-700 space-y-3">
                    <h3 class="text-lg font-medium text-slate-200">${title}</h3>
                    <div class="flex flex-wrap gap-2 min-h-[2.5rem]">
                        ${items.length > 0 ? items.sort().map((item) => `
                            <div class="flex items-center bg-slate-700 rounded-full px-3 py-1 animate-fade-in">
                                <span class="text-sm text-slate-100">${item}</span>
                                <button data-key="${key}" data-value="${item}" class="setting-delete-btn ml-2 text-red-400 hover:text-red-300 font-bold text-lg leading-none">
                                    &times;
                                </button>
                            </div>
                        `).join('') : '<p class="text-sm text-slate-500 px-2 py-1">No items added yet.</p>'}
                    </div>
                    <form class="flex gap-2 setting-add-form">
                        <input type="text" name="newItem" class="mobile-input flex-grow" placeholder="${placeholder}" required />
                        <input type="hidden" name="key" value="${key}" />
                        <button type="submit" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-500 transition-all">Add</button>
                    </form>
                </section>
                `;
            };

            contentEl.innerHTML = `
                <div class="bg-slate-800/80 backdrop-blur-sm border border-slate-700/50 rounded-2xl shadow-lg p-6 sm:p-8 space-y-6">
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Manage Dropdown Lists</h2>
                        <p class="text-slate-400 mt-1">Changes are saved instantly and shared with all staff.</p>
                    </div>
                    
                    ${renderCategory('requesters', 'Requesters', 'e.g. A DIV')}
                    ${renderCategory('escortBy', 'Escort By', 'e.g. SMM')}
                    ${renderCategory('vehicleTypes', 'Vehicle Types', 'e.g. Lorry')}
                    ${renderCategory('locations', 'Locations', 'e.g. HQ')}
                    ${renderCategory('approvedBy', 'Approved By', 'e.g. Jane Doe')}
                </div>
            `;
        };

        // *** UPDATED: applyFilter with contains search ***
        const applyFilter = () => {
            const searchBox = document.getElementById("searchBox");
            if (!searchBox) { 
                filtered = [];
                return; 
            }
            
            // Clean search term: remove spaces, uppercase
            const term = searchBox.value.replace(/\s/g, '').trim().toUpperCase();
            
            // Check if term is purely numeric
            const isNumericTerm = /^\d+$/.test(term); 
            
            if (!term) {
                filtered = [...allRows];
            } else {
                filtered = allRows.filter(r => {
                    if (!r.vehicleNumber) return false;
                    
                    // Normalize stored plate: remove spaces, uppercase (just in case)
                    const cleanPlate = r.vehicleNumber.replace(/\s/g, '').toUpperCase();
                    
                    if (isNumericTerm) {
                        // Numeric search: Check if the NUMBER sequence exists in the plate's numbers
                        const numericPartOfPlate = cleanPlate.replace(/[^0-9]/g, '');
                        return numericPartOfPlate.includes(term);
                    } else {
                        // Alphanumeric search: Check if the CLEAN plate includes the CLEAN term
                        // CHANGED from startsWith() to includes() to allow partial suffix matches (e.g. "18K")
                        return cleanPlate.includes(term);
                    }
                });
            }
            
            filtered.sort((a, b) => (b.expiryDate?.toMillis() || 0) - (a.expiryDate?.toMillis() || 0));
            
            if (currentView === 'search') {
                if (isGridView) {
                    // no specific action needed, renderGridView handles it
                } else {
                    render();
                }
            }
        };

        // --- Event Handlers ---
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Verifying...';
            
            const username = form.username.value;
            const password = form.password.value;
            let emailToLogin;

            try {
                const q = query(collection(db, "admins"), where("username", "==", username));
                const querySnap = await getDocs(q);

                if (querySnap.empty) {
                    console.warn(`No admin found with username: ${username}`);
                    throw new Error("Invalid username or password.");
                }

                const adminData = querySnap.docs[0].data();
                emailToLogin = adminData.email;

                if (!emailToLogin) {
                    console.error(`Admin doc for ${username} is missing 'email' field.`);
                    throw new Error("Admin account is not configured correctly.");
                }

                button.textContent = 'Logging in...';
                await signInWithEmailAndPassword(auth, emailToLogin, password);
                console.log("Login successful, waiting for auth state change...");

            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                let friendlyError = error.message;
                if (error.code === 'auth/invalid-credential' || error.message === "Invalid username or password.") {
                    friendlyError = "Invalid username or password.";
                } else if (error.code === 'auth/invalid-email') {
                    friendlyError = "Please enter a valid username.";
                }
                renderLoginScreen(friendlyError);
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out failed:", error);
                showNotification("Error signing out.", "error");
            }
        };

        const handleNavClick = (e) => {
            const view = e.target.closest('button')?.dataset.view;
            if (view && view !== currentView) {
                currentView = view;
                // Reset Grid View when leaving Search Tab
                if (view !== 'search') {
                    isGridView = false;
                }
                renderApp();
            }
        };

        // Handle Nav Dropdown
        const handleNavDropdownToggle = (e) => {
            const btn = e.target.closest('#nav-menu-btn');
            const dropdown = document.getElementById('nav-dropdown-menu');
            if (btn && dropdown) {
                dropdown.classList.toggle('show');
                e.stopPropagation();
            } else if (dropdown && !e.target.closest('.nav-dropdown')) {
                dropdown.classList.remove('show');
            }
        };
        
        // Handle Dropdown Item Click
        const handleNavDropdownItemClick = (e) => {
            const item = e.target.closest('.dropdown-item[data-view]');
            if (item) {
                const view = item.dataset.view;
                currentView = view;
                if (view !== 'search') isGridView = false;
                renderApp();
            }
        };

        const handleAddVehicle = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Adding...';

            try {
                if (!authUser) throw new Error("Authentication error. Please refresh and log in.");

                const data = Object.fromEntries(new FormData(form).entries());
                const entryDate = parseLocalDate(data.entryDate);
                const expiryDate = parseLocalDate(data.expiryDate);
                const isEscortRequired = data.escortRequired === 'on';

                // Clean vehicle number before saving (remove spaces)
                const cleanVehicleNumber = data.vehicleNumber.replace(/\s/g, '');

                if (!data.requester) throw new Error("Requester is required.");
                if (!cleanVehicleNumber) throw new Error("Vehicle Number is required.");
                if (!data.vehicleType) throw new Error("Vehicle Type is required.");
                if (!data.location) throw new Error("Location is required.");
                if (!data.timeSlot) throw new Error("Visiting Hours are required.");
                if (!entryDate || !expiryDate) throw new Error("Invalid entry or expiry date.");
                if (expiryDate < entryDate) throw new Error("Expiry date cannot be before the entry date.");
                if (isEscortRequired && !data.escortBy) throw new Error("Please select an escort team.");
                if (!data.approvedBy) throw new Error("Please select an approver.");

                const now = new Date();
                const existingActive = allRows.find(v => 
                    v.vehicleNumber === cleanVehicleNumber &&
                    v.expiryDate.toDate() >= now
                );

                if (existingActive) {
                    throw new Error(`Vehicle ${cleanVehicleNumber} already has an active clearance.`);
                }

                const payload = {
                    requester: data.requester,
                    vehicleNumber: cleanVehicleNumber,
                    ownerName: data.ownerName || "",
                    vehicleType: data.vehicleType,
                    location: data.location,
                    timeSlot: data.timeSlot,
                    entryDate: Timestamp.fromDate(entryDate),
                    expiryDate: Timestamp.fromDate(expiryDate),
                    notes: data.notes || "",
                    escortRequired: isEscortRequired,
                    escortBy: isEscortRequired ? data.escortBy : "",
                    approvedBy: data.approvedBy || "",
                    createdAt: Timestamp.now(),
                    createdBy: authUser.uid 
                };
                
                await addDoc(collection(db, DB_COLLECTION), payload);
                
                showNotification("Vehicle added to database successfully!", "success");
                form.reset();
                const escortContainer = document.getElementById('escort-details-container');
                if (escortContainer) escortContainer.classList.add('hidden');

            } catch (error) {
                console.error("Error adding vehicle:", error);
                showNotification(error.message, "error");
            } finally {
                button.disabled = false;
                button.textContent = 'Add Vehicle to Database';
            }
        };

        const handleClearSearch = () => {
            const searchBox = document.getElementById("searchBox");
            if (searchBox) searchBox.value = '';
            applyFilter();
        };

        const handleDropdownClick = (e) => {
            const moreBtn = e.target.closest('.more-btn');
            
            const openDropdowns = document.querySelectorAll('.dropdown-menu.show');
            openDropdowns.forEach(dropdown => {
                if (dropdown.id !== `dropdown-${moreBtn?.dataset.docId}`) {
                    dropdown.classList.remove('show');
                }
            });
            
            if (moreBtn) {
                const docId = moreBtn.dataset.docId;
                const dropdown = document.getElementById(`dropdown-${docId}`);
                if (dropdown) {
                    dropdown.classList.toggle('show');
                }
            } else if (!e.target.closest('.dropdown-menu')) {
                openDropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            }
        };
        
        const handleExitSingleView = () => {
            const searchBox = document.getElementById("searchBox");
            if (searchBox) searchBox.value = '';
            applyFilter();
        };

        // --- EDIT AND DELETE HANDLERS ---

        const handleMenuAction = (e) => {
            const editBtn = e.target.closest('.dropdown-item[data-action="edit"]');
            const deleteBtn = e.target.closest('.dropdown-item[data-action="delete"]');
            
            if (editBtn) {
                const docId = editBtn.dataset.id;
                handleEditClick(docId);
            } else if (deleteBtn) {
                const docId = deleteBtn.dataset.id;
                const vehicleNumber = deleteBtn.dataset.vehicleNumber;
                showModal(
                    `Delete ${vehicleNumber}?`,
                    "Are you sure you want to permanently delete this vehicle clearance? This action cannot be undone.",
                    () => handleConfirmDelete(docId)
                );
            }
        };

        const handleEditClick = (docId) => {
            const vehicle = allRows.find(v => v.id === docId);
            if (!vehicle) return;

            // Helper to create options and pre-select
            const createOptions = (arr, selected) => {
                if (!arr) return ''; 
                return arr.sort().map(item => `<option value="${item}" ${item === selected ? 'selected' : ''}>${item}</option>`).join('');
            };

            const editFormHTML = document.createElement('div');
            editFormHTML.innerHTML = `
                <form id="edit-vehicle-form" class="space-y-4">
                    <input type="hidden" name="docId" value="${vehicle.id}">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Requester</label>
                        <select name="requester" class="mobile-input" required>
                            <option value="">Select requester...</option>
                            ${createOptions(appSettings.requesters, vehicle.requester)}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Vehicle Number</label>
                        <input type="text" name="vehicleNumber" class="mobile-input uppercase font-mono" value="${formatVehicleNumber(vehicle.vehicleNumber)}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Owner Name</label>
                        <input type="text" name="ownerName" class="mobile-input" value="${vehicle.ownerName || ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Type</label>
                            <select name="vehicleType" class="mobile-input" required>
                                ${createOptions(appSettings.vehicleTypes, vehicle.vehicleType)}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Location</label>
                            <select name="location" class="mobile-input" required>
                                ${createOptions(appSettings.locations, vehicle.location)}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Visiting Hours</label>
                        <select name="timeSlot" class="mobile-input" required>
                            <option value="">Select...</option>
                            ${['08:00-13:00', '08:00-18:00', '13:00-18:00', '18:00-onwards', '24 Hours'].map(t => `<option value="${t}" ${t === vehicle.timeSlot ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Entry Date</label>
                            <input type="date" name="entryDate" class="mobile-input" value="${formatDate(vehicle.entryDate)}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Expiry Date</label>
                            <input type="date" name="expiryDate" class="mobile-input" value="${formatDate(vehicle.expiryDate)}" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Notes</label>
                        <textarea name="notes" class="mobile-input" rows="2">${vehicle.notes || ''}</textarea>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="editEscortRequired" name="escortRequired" class="mobile-checkbox" ${vehicle.escortRequired ? 'checked' : ''}>
                            <label for="editEscortRequired" class="text-sm font-medium text-slate-300">Escort Required</label>
                        </div>
                        <div id="edit-escort-details" class="${vehicle.escortRequired ? '' : 'hidden'} pl-8">
                            <select name="escortBy" class="mobile-input">
                                <option value="">Select escort...</option>
                                ${createOptions(appSettings.escortBy, vehicle.escortBy)}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Approved By</label>
                        <select name="approvedBy" class="mobile-input" required>
                            ${createOptions(appSettings.approvedBy, vehicle.approvedBy)}
                        </select>
                    </div>
                </form>
            `;

            // Attach checkbox logic for the edit form
            setTimeout(() => {
                const cb = editFormHTML.querySelector('#editEscortRequired');
                const det = editFormHTML.querySelector('#edit-escort-details');
                if(cb && det) {
                    cb.addEventListener('change', (e) => {
                        if(e.target.checked) det.classList.remove('hidden');
                        else det.classList.add('hidden');
                    });
                }
            }, 0);

            showModal(
                "Edit Vehicle Details",
                editFormHTML,
                async () => {
                    const form = document.getElementById('edit-vehicle-form');
                    if(!form.reportValidity()) return; // Basic HTML validation

                    const data = Object.fromEntries(new FormData(form).entries());
                    const entryDate = parseLocalDate(data.entryDate);
                    const expiryDate = parseLocalDate(data.expiryDate);
                    const isEscortRequired = data.escortRequired === 'on';
                    const cleanVehicleNumber = data.vehicleNumber.replace(/\s/g, '');

                    if(expiryDate < entryDate) {
                        showNotification("Expiry date cannot be before entry date.", "error");
                        return; // Don't close modal
                    }

                    try {
                        await updateDoc(doc(db, DB_COLLECTION, data.docId), {
                            requester: data.requester,
                            vehicleNumber: cleanVehicleNumber,
                            ownerName: data.ownerName || "",
                            vehicleType: data.vehicleType,
                            location: data.location,
                            timeSlot: data.timeSlot,
                            entryDate: Timestamp.fromDate(entryDate),
                            expiryDate: Timestamp.fromDate(expiryDate),
                            notes: data.notes || "",
                            escortRequired: isEscortRequired,
                            escortBy: isEscortRequired ? data.escortBy : "",
                            approvedBy: data.approvedBy || ""
                        });
                        showNotification("Vehicle updated successfully!", "success");
                        hideModal();
                    } catch(e) {
                        console.error(e);
                        showNotification("Error updating vehicle: " + e.message, "error");
                    }
                }
            );
        };

        const handleConfirmDelete = async (docId) => {
            if (!docId) return;
            if (!authUser) {
                showNotification("Authentication error. Please refresh.", "error");
                hideModal();
                return;
            }

            try {
                await deleteDoc(doc(db, DB_COLLECTION, docId));
                showNotification("Vehicle record deleted.", "success");
            } catch (error) {
                console.error("Error deleting document:", error);
                showNotification(`Error: ${error.message}`, "error");
            } finally {
                hideModal();
            }
        };
        
        const handleFormChange = (e) => {
            if (e.target.id === 'escortRequired') {
                const escortContainer = document.getElementById('escort-details-container');
                const escortSelect = document.getElementById('escortBy');
                if (e.target.checked) {
                    escortContainer.classList.remove('hidden');
                    escortSelect.required = true;
                } else {
                    escortContainer.classList.add('hidden');
                    escortSelect.required = false;
                    escortSelect.value = '';
                }
            }
        };
        
        // --- Settings Event Handlers ---
        
        const handleSettingAdd = async (e) => {
            e.preventDefault();
            const form = e.target.closest('.setting-add-form');
            if (!form) return;
            if (!authUser) {
                showNotification("Authentication error. Please refresh.", "error");
                return;
            }

            const key = form.key.value;
            const newItemInput = form.newItem;
            const newItem = sanitizeInput(newItemInput.value);

            if (!newItem) return;
            
            if (appSettings[key] && appSettings[key].map(i => i.toLowerCase()).includes(newItem.toLowerCase())) {
                showNotification("This item already exists in the list.", "info");
                return;
            }

            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;

            try {
                await updateDoc(settingsDocRef, {
                    [key]: arrayUnion(newItem)
                });
                showNotification("Item added to settings.", "success");
            } catch (error) {
                console.error("Error adding setting:", error);
                showNotification(`Error: ${error.message}`, "error");
            } finally {
                button.disabled = false;
                newItemInput.value = '';
            }
        };

        const handleSettingDelete = async (e) => {
            const button = e.target.closest('.setting-delete-btn');
            if (!button) return;
            if (!authUser) {
                showNotification("Authentication error. Please refresh.", "error");
                return;
            }
            
            const { key, value } = button.dataset;
            if (!key || !value) return;

            button.disabled = true;
            
            try {
                await updateDoc(settingsDocRef, {
                    [key]: arrayRemove(value)
                });
                showNotification("Item removed from settings.", "success");
            } catch (error) {
                console.error("Error removing setting:", error);
                showNotification(`Error: ${error.message}`, "error");
                button.disabled = false;
            }
        };

        // *** NEW: Batch Delete Logic ***
        const handleBatchDeleteExpired = () => {
            const expiredDocs = allRows.filter(v => getVehicleStatus(v) === 'expired');
            const count = expiredDocs.length;

            if (count === 0) {
                showNotification("No expired vehicles found.", "info");
                return;
            }

            showModal(
                "Delete Expired Vehicles?",
                `Found ${count} expired vehicle records. This will permanently delete them from the database.`,
                async () => {
                    hideModal();
                    try {
                        const batch = writeBatch(db);
                        expiredDocs.forEach(docData => {
                            const docRef = doc(db, DB_COLLECTION, docData.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                        showNotification(`Successfully deleted ${count} expired records.`, "success");
                    } catch (error) {
                        console.error("Batch delete error:", error);
                        showNotification(`Batch delete failed: ${error.message}`, "error");
                    }
                }
            );
        };

        // --- Global Event Listeners ---
        
        appRoot.addEventListener("click", (e) => {
            handleNavClick(e);
            handleNavDropdownToggle(e);
            handleNavDropdownItemClick(e);
            handleMenuAction(e); // Handles both Edit and Delete
            handleSettingDelete(e);
            handleDropdownClick(e);
            
            const keypadBtn = e.target.closest('.keypad-btn');
            const clearBtn = e.target.id === 'clear-search-btn';
            const exitBtn = e.target.id === 'exit-single-view-btn';
            const signOutBtn = e.target.id === 'sign-out-btn' || e.target.closest('#sign-out-btn');
            
            // New Grid View Buttons
            const showAllBtn = e.target.closest('#show-all-btn');
            const backSearchBtn = e.target.id === 'back-to-search-btn';
            const batchDeleteBtn = e.target.closest('#batch-delete-expired-btn');

            if (showAllBtn) {
                isGridView = true;
                renderGridView();
            }
            
            if (backSearchBtn) {
                isGridView = false;
                renderSearchView();
            }

            if (batchDeleteBtn) {
                handleBatchDeleteExpired();
            }

            if (keypadBtn) {
                const searchBox = document.getElementById('searchBox');
                if (!searchBox) return;

                const action = keypadBtn.dataset.action;
                const toggleId = keypadBtn.id;
                
                if (toggleId === 'keypad-toggle-alpha') {
                    keypadMode = 'alpha';
                    const currentSearch = searchBox.value; 
                    renderKeypad(); 
                    document.getElementById('searchBox').value = currentSearch;
                    return;
                }
                if (toggleId === 'keypad-toggle-numeric') {
                    keypadMode = 'numeric';
                    const currentSearch = searchBox.value; 
                    renderKeypad(); 
                    document.getElementById('searchBox').value = currentSearch; 
                    return;
                }
                
                if (action === 'backspace') {
                    // Handle backspace logic while preserving format
                    const clean = searchBox.value.replace(/\s/g, '');
                    const newClean = clean.slice(0, -1);
                    searchBox.value = formatVehicleNumber(newClean);
                } else {
                    const t = keypadBtn.textContent.trim();
                    if (t) {
                        const clean = searchBox.value.replace(/\s/g, '');
                        if (clean.length < 10) {
                            searchBox.value = formatVehicleNumber(clean + t);
                        }
                    }
                }
                applyFilter();
            }
            
            if (clearBtn) {
                handleClearSearch();
            }
            if (exitBtn) {
                handleExitSingleView();
            }
            if (signOutBtn) {
                handleSignOut();
            }
        });
        
        appRoot.addEventListener("change", (e) => {
            handleFormChange(e);
        });
        
        appRoot.addEventListener("submit", (e) => {
            e.preventDefault(); 
            if (e.target.id === 'login-form') {
                handleLogin(e);
            } else if (e.target.id === 'add-vehicle-form') {
                handleAddVehicle(e);
            } else if (e.target.classList.contains('setting-add-form')) {
                handleSettingAdd(e); 
            }
        });
        
        modalCancelBtn.addEventListener("click", hideModal);
        modalConfirmBtn.addEventListener("click", () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
        });

    </script>
</body>
</html>


